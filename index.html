<!-- --- START OF FILE Task_MS_V.2.3.1.html --- -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODF Task Manager V.2.3.1 (Fix)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ODF</text></svg>">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts (Prompt) -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js for KPI -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f4f6f9; overflow-x: hidden; }
        [v-cloak] { display: none !important; }
        
        /* Sidebar Styling */
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; transition: all 0.3s; position: relative; width: 250px; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-link span, 
        .sidebar.collapsed .user-info, 
        .sidebar.collapsed .sidebar-header span { display: none; }
        .sidebar.collapsed .sidebar-header { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed .nav-link { text-align: center; padding: 10px 5px; }
        .sidebar.collapsed .nav-link i { font-size: 1.4rem; margin-right: 0 !important; }
        
        /* Nav Links */
        .nav-link { color: rgba(255,255,255,0.8); cursor: pointer; white-space: nowrap; margin-bottom: 2px; padding: 10px 15px; font-size: 0.95rem; display: flex; align-items: center; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .nav-link i { font-size: 1.1rem; margin-right: 10px; width: 25px; text-align: center; }

        /* Card & UI */
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 12px; margin-bottom: 20px; transition: transform 0.2s; }
        .card-clickable:hover { transform: translateY(-5px); cursor: pointer; opacity: 0.95; }
        
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 20px; }
        
        /* Chat Scroll */
        .chat-box { height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 10px; padding: 15px; scroll-behavior: smooth; }
        
        .chat-message { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; }
        .chat-mine { background: #d1e7dd; margin-left: auto; }
        .chat-other { background: #e2e3e5; }
        .file-attachment { background: #e9ecef; padding: 5px 10px; border-radius: 5px; display: inline-block; margin-right: 5px; margin-bottom: 5px; font-size: 0.9em; }
        
        /* Star Rating */
        .star-rating i { font-size: 1.3rem; color: #ddd; cursor: pointer; transition: color 0.2s; margin-right: 2px; }
        .star-rating i.active { color: #ffc107; }
        .star-display i { color: #ddd; font-size: 1rem; margin-right: 1px; }
        .star-display i.active { color: #ffc107; }
        
        /* KPI Chart Container */
        .chart-container { position: relative; height: 350px; width: 100%; }

        /* Modal Transition */
        .modal.fade .modal-dialog { transform: scale(0.95); transition: transform 0.2s ease-out; }
        .modal.show .modal-dialog { transform: scale(1); }

        /* User Selection Checkbox Area */
        .user-select-container { max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; background: white; }
        
        .ring-active { border: 3px solid #ffc107 !important; transform: scale(1.02); }

        /* SOP Tabs Styling */
        .nav-tabs .nav-link { color: #333 !important; border: 1px solid #dee2e6; margin-right: 2px; background: #f8f9fa; }
        .nav-tabs .nav-link.active { color: #000 !important; font-weight: bold; background: #fff; border-bottom-color: transparent; border-top: 3px solid #2c3e50; }
        .nav-tabs .nav-link:hover { background: #e9ecef; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <!-- ================== LOGIN PAGE ================== -->
    <div v-if="!currentUser" class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card p-5 shadow-lg" style="width: 400px;">
            <h3 class="text-center mb-4 text-primary fw-bold">ODF Task Manager</h3>
            <div class="mb-3">
                <label>Username</label>
                <input type="text" v-model="loginForm.username" class="form-control" placeholder="user" @keyup.enter="login">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" v-model="loginForm.password" class="form-control" placeholder="pass" @keyup.enter="login">
            </div>
            <button @click="login" class="btn btn-primary w-100" :disabled="loading">
                <span v-if="loading" class="spinner-border spinner-border-sm"></span> เข้าสู่ระบบ
            </button>
            <small class="text-muted d-block text-center mt-3">Demo: manager / 1234 หรือ team1 / 1234</small>
        </div>
    </div>

    <!-- ================== MAIN APP ================== -->
    <div v-else class="d-flex">
        
        <!-- Sidebar -->
        <div :class="['sidebar d-flex flex-column flex-shrink-0 p-3', isSidebarOpen ? '' : 'collapsed']">
            <div class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none sidebar-header justify-content-between w-100">
                <span class="fs-5 fw-bold"><i class="bi bi-grid-fill me-2"></i>ODF System</span>
                <i class="bi bi-list fs-5" style="cursor: pointer;" @click="toggleSidebar"></i>
            </div>
            <hr class="my-2">
            <div class="mb-3 user-info ps-2">
                <div class="fw-bold text-truncate">{{ currentUser.name }}</div>
                <small class="badge bg-warning text-dark">{{ currentUser.role === 'manager' ? 'Manager' : 'Team' }}</small>
                <small class="text-white-50 d-block">{{ currentUser.department }}</small>
            </div>
            
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a @click="currentView = 'dashboard'" :class="['nav-link', currentView === 'dashboard' ? 'active' : '']" title="Dashboard">
                        <i class="bi bi-speedometer2"></i> <span>ภาพรวมงาน</span>
                    </a>
                </li>
                <li>
                    <a @click="currentView = 'my_tasks'" :class="['nav-link', currentView === 'my_tasks' ? 'active' : '']" title="งานของฉัน">
                        <i class="bi bi-person-check"></i> <span>งานของฉัน</span>
                    </a>
                </li>
                <!-- Revision Menu -->
                <li>
                    <a @click="currentView = 'revisions'" :class="['nav-link', currentView === 'revisions' ? 'active' : '']" title="งานแก้ (Revision)">
                        <i class="bi bi-arrow-repeat"></i> <span>งานแก้ (Revision)</span>
                    </a>
                </li>
                <li>
                    <a @click="currentView = 'tasks'; dashboardFilter=null" :class="['nav-link', currentView === 'tasks' ? 'active' : '']" title="งานทั้งหมด">
                        <i class="bi bi-list-task"></i> <span>งานทั้งหมด</span>
                    </a>
                </li>
                
                <!-- KPI Menus -->
                 <li>
                    <hr class="text-white-50 my-1">
                </li>
                <!-- Manager KPI -->
                <div v-if="currentUser.role === 'manager'">
                    <li>
                        <a @click="currentView = 'review'" :class="['nav-link', currentView === 'review' ? 'active' : '']" title="รอประเมิน">
                            <i class="bi bi-star-half"></i> <span>Review ({{ pendingReviewCount }})</span>
                        </a>
                    </li>
                    <li>
                        <a @click="currentView = 'kpi'" :class="['nav-link', currentView === 'kpi' ? 'active' : '']" title="KPI Overview">
                            <i class="bi bi-graph-up-arrow"></i> <span>KPI (ภาพรวม)</span>
                        </a>
                    </li>
                    <li>
                        <a @click="currentView = 'one_on_one'" :class="['nav-link', currentView === 'one_on_one' ? 'active' : '']" title="1 on 1 Report">
                            <i class="bi bi-person-video2"></i> <span>1 On 1 (รายบุคคล)</span>
                        </a>
                    </li>
                </div>
                <!-- Team KPI -->
                <div v-else>
                     <li>
                        <a @click="currentView = 'my_kpi'" :class="['nav-link', currentView === 'my_kpi' ? 'active' : '']" title="My Performance">
                            <i class="bi bi-graph-up"></i> <span>My KPI</span>
                        </a>
                    </li>
                </div>

                <li>
                    <hr class="text-white-50 my-1">
                </li>
                <li>
                    <a @click="currentView = 'sop'" :class="['nav-link', currentView === 'sop' ? 'active' : '']" title="SOP / WI / JD">
                        <i class="bi bi-folder2-open"></i> <span>คลังเอกสาร</span>
                    </a>
                </li>

                <!-- Admin Menus -->
                <div v-if="currentUser.role === 'manager'">
                    <li>
                        <hr class="text-white-50 my-1">
                    </li>
                    <li>
                        <a @click="currentView = 'users'" :class="['nav-link', currentView === 'users' ? 'active' : '']" title="จัดการทีม">
                            <i class="bi bi-people"></i> <span>จัดการทีม</span>
                        </a>
                    </li>
                    <li>
                        <a @click="currentView = 'departments'" :class="['nav-link', currentView === 'departments' ? 'active' : '']" title="จัดการแผนก">
                            <i class="bi bi-building-gear"></i> <span>จัดการแผนก</span>
                        </a>
                    </li>
                </div>
            </ul>
            <hr>
            <button @click="logout" class="btn btn-outline-light btn-sm w-100">
                <i class="bi bi-box-arrow-right"></i> <span v-if="isSidebarOpen">ออกจากระบบ</span>
            </button>
        </div>

        <!-- Content Area -->
        <div class="flex-grow-1 p-4" style="height: 100vh; overflow-y: auto;">
            
            <!-- Dashboard View -->
            <div v-if="currentView === 'dashboard'">
                <h2 class="mb-4">
                    ภาพรวมงาน (Dashboard) 
                    <small class="text-muted fs-6" v-if="currentUser.role !== 'manager'">(เฉพาะงานของคุณ)</small>
                </h2>
                
                <!-- Stats Cards -->
                <div class="row g-2 mb-4">
                    <!-- 1. Total -->
                    <div class="col-md">
                        <div @click="setDashboardDetailFilter('')" :class="['card card-clickable p-3 h-100', dashboardDetailFilter==='' ? 'ring-active' : '']" style="background:#0d6efd; color:white;">
                            <h6 class="text-uppercase small opacity-75">งานทั้งหมด</h6>
                            <h2 class="display-6 fw-bold">{{ dashboardStats.total }}</h2>
                        </div>
                    </div>
                    <!-- 2. Urgent -->
                    <div class="col-md">
                        <div @click="setDashboardDetailFilter('urgent')" :class="['card card-clickable bg-danger text-white p-3 h-100', dashboardDetailFilter==='urgent' ? 'ring-active' : '']">
                            <h6 class="text-uppercase small opacity-75">งานด่วน (ทำอยู่)</h6>
                            <h2 class="display-6 fw-bold">{{ dashboardStats.urgent }}</h2>
                        </div>
                    </div>
                    <!-- 3. Revision (NEW) -->
                    <div class="col-md">
                        <div @click="setDashboardDetailFilter('revision')" :class="['card card-clickable text-white p-3 h-100', dashboardDetailFilter==='revision' ? 'ring-active' : '']" style="background-color: #6f42c1;">
                            <h6 class="text-uppercase small opacity-75">งานแก้ (ทำอยู่)</h6>
                            <h2 class="display-6 fw-bold">{{ dashboardStats.revision }}</h2>
                        </div>
                    </div>
                    <!-- 4. Pending -->
                    <div class="col-md">
                        <div @click="setDashboardDetailFilter('pending')" :class="['card card-clickable bg-warning text-dark p-3 h-100', dashboardDetailFilter==='pending' ? 'ring-active' : '']">
                            <h6 class="text-uppercase small opacity-75">รอดำเนินการ</h6>
                            <h2 class="display-6 fw-bold">{{ dashboardStats.pending }}</h2>
                        </div>
                    </div>
                    <!-- 5. In Progress -->
                    <div class="col-md">
                        <div @click="setDashboardDetailFilter('in_progress')" :class="['card card-clickable bg-info text-white p-3 h-100', dashboardDetailFilter==='in_progress' ? 'ring-active' : '']">
                            <h6 class="text-uppercase small opacity-75">กำลังทำ</h6>
                            <h2 class="display-6 fw-bold">{{ dashboardStats.inProgress }}</h2>
                        </div>
                    </div>
                    <!-- 6. Overdue -->
                    <div class="col-md">
                        <div @click="setDashboardDetailFilter('overdue')" :class="['card card-clickable bg-secondary text-white p-3 h-100 position-relative', dashboardDetailFilter==='overdue' ? 'ring-active' : '']">
                            <h6 class="text-uppercase small opacity-75">ล่าช้า</h6>
                            <h2 class="display-6 fw-bold">{{ dashboardStats.overdue }}</h2>
                            <i class="bi bi-exclamation-triangle position-absolute top-0 end-0 m-2 opacity-50"></i>
                        </div>
                    </div>
                    <!-- 7. Completed -->
                    <div class="col-md">
                        <div @click="setDashboardDetailFilter('completed')" :class="['card card-clickable bg-success text-white p-3 h-100', dashboardDetailFilter==='completed' ? 'ring-active' : '']">
                            <h6 class="text-uppercase small opacity-75">เสร็จสิ้น</h6>
                            <h2 class="display-6 fw-bold">{{ dashboardStats.completed }}</h2>
                        </div>
                    </div>
                </div>

                <!-- Detail List Section -->
                <div class="card p-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> 
                            รายการงาน: <span class="text-primary">{{ getDashboardFilterName(dashboardDetailFilter) }}</span>
                        </h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ชื่องาน</th>
                                    <th>ผู้รับผิดชอบ</th>
                                    <th>สถานะ</th>
                                    <th>กำหนดส่ง</th>
                                    <th>คะแนนประเมิน</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="task in dashboardDetailTasks" :key="task.id" @click="openTaskDetail(task)" style="cursor: pointer;">
                                    <td>
                                        <div class="fw-bold">{{ task.title }}</div>
                                        <span v-if="task.priority === 'urgent'" class="badge bg-danger rounded-pill me-1" style="font-size:0.7em">ด่วน</span>
                                        <span v-if="task.is_revision" class="badge bg-primary rounded-pill me-1" style="font-size:0.7em">งานแก้</span>
                                        <span v-if="isOverdue(task)" class="badge bg-dark rounded-pill" style="font-size:0.7em">ล่าช้า</span>
                                    </td>
                                    <td>{{ getAssignedNames(task.assigned_to) }}</td>
                                    <td><span :class="getStatusBadge(task.status)">{{ getStatusText(task.status) }}</span></td>
                                    <td :class="isOverdue(task) ? 'text-danger fw-bold' : ''">{{ formatDateTime(task.due_date) }}</td>
                                    <td>
                                        <div v-if="task.evaluation">
                                            <div class="star-display">
                                                <i v-for="n in 5" :class="['bi', n <= Math.round(getTotalScore(task.evaluation)/4) ? 'bi-star-fill active' : 'bi-star-fill']"></i>
                                                <span class="text-success fw-bold ms-1" style="font-size:0.8em">{{ getTotalScore(task.evaluation) }}/20</span>
                                            </div>
                                        </div>
                                        <span v-else class="text-muted small">-</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> ดู</button>
                                    </td>
                                </tr>
                                <tr v-if="dashboardDetailTasks.length === 0">
                                    <td colspan="6" class="text-center py-4 text-muted">ไม่พบข้อมูลในหมวดนี้</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tasks View / My Tasks / Revisions -->
            <div v-if="['tasks', 'my_tasks', 'revisions'].includes(currentView)">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <h2>
                        <i v-if="currentView === 'my_tasks'" class="bi bi-person-check"></i>
                        <i v-else-if="currentView === 'revisions'" class="bi bi-arrow-repeat"></i>
                        <i v-else class="bi bi-list-task"></i>
                        
                        <span v-if="currentView === 'my_tasks'">งานของฉัน</span>
                        <span v-else-if="currentView === 'revisions'">รายการงานแก้ (Revision List)</span>
                        <span v-else>รายการงานทั้งหมด</span>
                    </h2>
                    
                    <div class="d-flex gap-2 align-items-center">
                        <select v-if="currentView === 'tasks'" class="form-select w-auto" v-model="filterStatus">
                            <option value="">สถานะ: ทั้งหมด</option>
                            <option value="urgent">งานด่วน</option>
                            <option value="pending">รอดำเนินการ</option>
                            <option value="in_progress">กำลังดำเนินการ</option>
                            <option value="completed">เสร็จสิ้น</option>
                            <option value="overdue">ล่าช้า</option>
                        </select>

                        <select v-if="currentView === 'tasks' && currentUser.role === 'manager'" class="form-select w-auto" v-model="filterUser">
                            <option value="">บุคคล: ทั้งหมด</option>
                            <option v-for="u in users" :key="u.id" :value="u.id">{{ u.name }}</option>
                        </select>
                        <button v-if="currentUser.role === 'manager'" @click="openTaskModal()" class="btn btn-primary">
                            <i class="bi bi-plus-lg"></i> สร้างงานใหม่
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div v-for="task in filteredTasks" :key="task.id" class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm" :class="{'border-primary': task.is_revision && task.status!=='completed'}">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between mb-2">
                                    <div>
                                        <span v-if="task.priority === 'urgent'" class="badge bg-danger me-1">ด่วน</span>
                                        <span v-if="task.is_revision" class="badge bg-primary me-1">งานแก้</span>
                                        <span v-if="isOverdue(task)" class="badge bg-dark">ล่าช้า</span>
                                    </div>
                                    <span :class="getStatusBadge(task.status)">{{ getStatusText(task.status) }}</span>
                                </div>
                                <h5 class="card-title fw-bold">{{ task.title }}</h5>
                                <p class="card-text text-muted text-truncate">{{ task.description }}</p>
                                
                                <div class="mt-auto">
                                    <div class="bg-light p-2 rounded mb-2" style="font-size: 0.85em;">
                                        <div><i class="bi bi-calendar-check me-1"></i> เริ่ม: {{ formatDateTime(task.start_date) }}</div>
                                        <div :class="isOverdue(task) ? 'text-danger fw-bold' : ''">
                                            <i class="bi bi-alarm me-1"></i> ส่ง: {{ formatDateTime(task.due_date) }}
                                        </div>
                                    </div>
                                    
                                    <small class="text-muted d-block mb-3">
                                        <i class="bi bi-person-fill"></i> {{ getAssignedNames(task.assigned_to) }}
                                    </small>

                                    <div class="d-flex gap-2">
                                        <button @click="openTaskDetail(task)" class="btn btn-outline-primary btn-sm flex-grow-1">รายละเอียด</button>
                                        
                                        <div v-if="currentUser.role === 'manager'">
                                            <button @click="openTaskModal(task)" class="btn btn-outline-warning btn-sm"><i class="bi bi-pencil"></i></button>
                                            <button @click="deleteTask(task.id)" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="filteredTasks.length === 0" class="col-12 text-center text-muted mt-5">
                        <i class="bi bi-inbox fs-1"></i>
                        <p>ไม่พบรายการงาน</p>
                    </div>
                </div>
            </div>

            <!-- Review View (Manager) -->
            <div v-if="currentView === 'review' && currentUser.role === 'manager'">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Review งาน ({{ reviewMode === 'pending' ? 'รอประเมิน' : 'ประวัติ' }})</h2>
                    <div class="btn-group">
                        <button @click="reviewMode = 'pending'" :class="['btn', reviewMode==='pending' ? 'btn-primary' : 'btn-outline-primary']">รอประเมิน</button>
                        <button @click="reviewMode = 'history'" :class="['btn', reviewMode==='history' ? 'btn-primary' : 'btn-outline-primary']">ประวัติ (แก้ไข)</button>
                    </div>
                </div>
                
                <div class="card p-4">
                    <table class="table table-hover">
                        <thead><tr><th>ชื่องาน</th><th>ผู้รับผิดชอบ</th><th>เสร็จเมื่อ</th><th>คะแนนรวม</th><th>จัดการ</th></tr></thead>
                        <tbody>
                            <tr v-for="task in reviewListTasks" :key="task.id">
                                <td>
                                    {{ task.title }}
                                    <span v-if="task.is_revision" class="badge bg-primary ms-1">Rev</span>
                                </td>
                                <td>{{ getAssignedNames(task.assigned_to) }}</td>
                                <td>{{ formatDateTime(task.completed_at || task.updated_at) }}</td>
                                <td>
                                    <div v-if="task.evaluation">
                                        <div class="star-display">
                                            <i v-for="n in 5" :class="['bi', n <= Math.round(getTotalScore(task.evaluation)/4) ? 'bi-star-fill active' : 'bi-star-fill']"></i>
                                            <span class="text-success fw-bold ms-1">{{ getTotalScore(task.evaluation) }}/20</span>
                                        </div>
                                    </div>
                                    <span v-else class="text-muted">-</span>
                                </td>
                                <td>
                                    <button @click="openEvaluation(task)" class="btn btn-warning btn-sm">
                                        <i class="bi bi-star"></i> {{ task.evaluation ? 'แก้ไขคะแนน' : 'ให้คะแนน' }}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- KPI View (Manager: Overview) OR My KPI (Team) OR 1-on-1 -->
            <div v-if="['kpi', 'my_kpi', 'one_on_one'].includes(currentView)">
                <div class="d-flex justify-content-between mb-4 flex-wrap gap-2">
                    <h2>
                        <span v-if="currentView === 'kpi'">KPI ภาพรวม (ทั้งหมด)</span>
                        <span v-if="currentView === 'my_kpi'">My KPI & Performance</span>
                        <span v-if="currentView === 'one_on_one'">1 On 1 Report</span>
                    </h2>
                    
                    <div class="d-flex flex-wrap gap-2 align-items-center bg-white p-2 rounded shadow-sm">
                        <!-- User Selector for 1 on 1 -->
                        <div v-if="currentView === 'one_on_one'" class="me-2">
                            <select v-model="kpiSelectedUser" @change="calculateKPI" class="form-select bg-light border-primary">
                                <option :value="null">-- เลือกพนักงาน --</option>
                                <option v-for="u in users" :key="u.id" :value="u.id">{{ u.name }}</option>
                            </select>
                        </div>

                        <!-- Date Shortcuts Fixed Dropdown -->
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm w-auto" v-model="kpiSelectedMonth" @change="updateKpiDateFromDropdown">
                                <option value="">- เลือกเดือน -</option>
                                <option v-for="(m, i) in 12" :key="m" :value="i+1">
                                    {{ ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'][i] }}
                                </option>
                            </select>
                            <select class="form-select form-select-sm w-auto" v-model="kpiSelectedYear" @change="updateKpiDateFromDropdown">
                                <option value="">- เลือกปี -</option>
                                <option v-for="y in 5" :key="y" :value="new Date().getFullYear() - 2 + y">
                                    {{ new Date().getFullYear() - 2 + y }}
                                </option>
                            </select>
                        </div>

                        <button @click="calculateKPI" class="btn btn-primary btn-sm">Update</button>
                        
                        <div class="ms-2 text-muted small">
                            ช่วง: {{ formatDateTime(kpiStartDate).split(' ')[0] }} - {{ formatDateTime(kpiEndDate).split(' ')[0] }}
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Chart -->
                    <div class="col-md-12" v-if="currentView !== 'one_on_one' || kpiSelectedUser">
                        <div class="card p-4">
                            <h5>คะแนนเฉลี่ย (Score Breakdown)</h5>
                            <div class="chart-container">
                                <canvas id="kpiChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Tasks -->
                    <div class="col-md-12" v-if="currentView !== 'one_on_one' || kpiSelectedUser">
                        <div class="card p-4">
                            <h5>อันดับงานคะแนนสูงสุด (ในขอบเขตที่เลือก)</h5>
                            <table class="table table-hover">
                                <thead><tr><th>Rank</th><th>ชื่องาน</th><th>ผู้ทำ</th><th>คะแนนรวม</th><th>Note</th></tr></thead>
                                <tbody>
                                    <tr v-for="(task, index) in topRatedTasks" :key="task.id" @click="openTaskDetail(task)" style="cursor: pointer;">
                                        <td>#{{ index + 1 }}</td>
                                        <td>{{ task.title }}</td>
                                        <td>{{ getAssignedNames(task.assigned_to) }}</td>
                                        <td class="fw-bold text-success">{{ getTotalScore(task.evaluation) }}/20</td>
                                        <td class="text-muted fst-italic">{{ task.evaluation.note || '-' }}</td>
                                    </tr>
                                    <tr v-if="topRatedTasks.length===0"><td colspan="5" class="text-center text-muted">ไม่มีข้อมูลในช่วงเวลานี้</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div v-if="currentView === 'one_on_one' && !kpiSelectedUser" class="col-12 text-center text-muted py-5">
                         <h4>กรุณาเลือกรายชื่อพนักงานด้านบน เพื่อดูรายงาน</h4>
                    </div>
                </div>
            </div>

            <!-- Users Management View -->
            <div v-if="currentView === 'users' && currentUser.role === 'manager'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>จัดการทีม</h2>
                    <button @click="openUserModal()" class="btn btn-primary"><i class="bi bi-person-plus"></i> เพิ่มสมาชิก</button>
                </div>
                <div class="card p-4">
                    <table class="table">
                        <thead><tr><th>ชื่อ</th><th>แผนก</th><th>Username</th><th>Role</th><th>จัดการ</th></tr></thead>
                        <tbody>
                            <tr v-for="u in users" :key="u.id">
                                <td>{{ u.name }}</td>
                                <td>{{ u.department }}</td>
                                <td>{{ u.username }}</td>
                                <td>
                                    <span :class="u.role === 'manager' ? 'badge bg-danger' : 'badge bg-info text-dark'">{{ u.role }}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning me-1" @click="openUserModal(u)">แก้ไข</button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteUser(u.id)">ลบ</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

             <!-- Departments Management View -->
            <div v-if="currentView === 'departments' && currentUser.role === 'manager'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>จัดการแผนก</h2>
                    <button @click="openDeptModal()" class="btn btn-primary"><i class="bi bi-plus-lg"></i> เพิ่มแผนก</button>
                </div>
                <div class="card p-4 col-md-8 mx-auto">
                     <table class="table table-striped">
                        <thead><tr><th>ชื่อแผนก</th><th width="150">จัดการ</th></tr></thead>
                        <tbody>
                            <tr v-for="(dept, idx) in departmentsList" :key="idx">
                                <td>{{ dept }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning me-2" @click="openDeptModal(dept, idx)">แก้ไข</button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteDept(idx)">ลบ</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SOP / WI / JD View -->
            <div v-if="currentView === 'sop'">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h2>คลังเอกสาร</h2>
                    <button v-if="currentUser.role === 'manager'" @click="openDocModal()" class="btn btn-primary">
                        <i class="bi bi-cloud-upload"></i> อัปโหลดเอกสาร
                    </button>
                </div>

                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <ul class="nav nav-tabs border-bottom-0">
                            <li class="nav-item"><a @click="sopTab='JD'" :class="['nav-link', sopTab==='JD'?'active':'']">Job Description</a></li>
                            <li class="nav-item"><a @click="sopTab='WI'" :class="['nav-link', sopTab==='WI'?'active':'']">Work Instruction</a></li>
                            <li class="nav-item"><a @click="sopTab='SOP'" :class="['nav-link', sopTab==='SOP'?'active':'']">SOP Standard</a></li>
                            <li class="nav-item ms-3" v-if="currentUser.role==='manager'"><a @click="sopTab='MANAGE'" :class="['nav-link text-danger', sopTab==='MANAGE'?'active':'']"><i class="bi bi-gear"></i> จัดการรายชื่อ/สิทธิ์</a></li>
                        </ul>

                        <div class="d-flex gap-2 align-items-center" v-if="sopTab !== 'MANAGE'">
                             <div v-if="currentUser.role === 'manager'">
                                <select v-model="sopFilterDept" class="form-select form-select-sm" style="width: 150px;">
                                    <option value="">ทุกแผนก</option>
                                    <option v-for="d in departmentsList" :value="d">{{d}}</option>
                                </select>
                             </div>
                             <div v-else class="text-muted small">
                                <i class="bi bi-info-circle"></i> แสดงเฉพาะแผนกของคุณ และ General
                             </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive" v-if="sopTab !== 'MANAGE'">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ชื่อเอกสาร</th>
                                    <th>แผนก/ผู้ได้รับสิทธิ์</th>
                                    <th>ดาวน์โหลด</th>
                                    <th>สถานะการอ่าน</th>
                                    <th v-if="currentUser.role==='manager'">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="doc in filteredDocs" :key="doc.id">
                                    <td><i class="bi bi-file-earmark-pdf text-danger me-2"></i> {{ doc.title }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ doc.department }}</span>
                                        <small v-if="doc.target_user_id" class="text-primary d-block">เฉพาะ: {{ getUserName(doc.target_user_id) }}</small>
                                    </td>
                                    <td><a :href="doc.url" target="_blank" class="btn btn-sm btn-outline-primary">เปิดอ่าน</a></td>
                                    
                                    <td>
                                        <div v-if="currentUser.role === 'manager'">
                                            <span class="text-muted small">ตรวจสอบในแท็บจัดการ</span>
                                        </div>
                                        <div v-else>
                                            <button v-if="!hasUserRead(doc.id, currentUser.id)" @click="markDocRead(doc.id)" class="btn btn-sm btn-outline-success">
                                                <i class="bi bi-check-circle"></i> ยืนยันการอ่าน
                                            </button>
                                            <span v-else class="text-success"><i class="bi bi-check-circle-fill"></i> รับทราบแล้ว</span>
                                        </div>
                                    </td>

                                    <td v-if="currentUser.role==='manager'">
                                        <button @click="deleteDoc(doc.id)" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="filteredDocs.length === 0"><td colspan="5" class="text-center py-4">ไม่พบเอกสาร</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div v-if="sopTab === 'MANAGE' && currentUser.role === 'manager'" class="p-3">
                        <div class="alert alert-info">จัดการการผูกเอกสารเข้ากับรายชื่อพนักงาน (คลิกปุ่มแก้ไขที่เอกสารเพื่อเปลี่ยนสิทธิ์)</div>
                        <table class="table">
                            <thead><tr><th>เอกสาร</th><th>ประเภท</th><th>สิทธิ์ปัจจุบัน</th><th>จัดการ</th></tr></thead>
                            <tbody>
                                <tr v-for="doc in documents" :key="'m'+doc.id">
                                    <td>{{ doc.title }}</td>
                                    <td>{{ doc.category }}</td>
                                    <td>
                                        <span v-if="doc.target_user_id" class="text-primary fw-bold"><i class="bi bi-person"></i> {{ getUserName(doc.target_user_id) }}</span>
                                        <span v-else class="text-secondary"><i class="bi bi-building"></i> แผนก {{ doc.department }}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" @click="openDocEdit(doc)">แก้ไขสิทธิ์</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ================== MODALS ================== -->

    <!-- Create/Edit Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ editingTask.id ? 'แก้ไขงาน' : 'สร้างงานใหม่' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label required fw-bold">หัวข้องาน <span class="text-danger">*</span></label>
                            <input type="text" v-model="editingTask.title" class="form-control" :class="{'is-invalid': attemptSave && !editingTask.title}">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">รายละเอียด <span class="text-danger">*</span></label>
                            <textarea v-model="editingTask.description" class="form-control" rows="3" :class="{'is-invalid': attemptSave && !editingTask.description}"></textarea>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">วันที่เริ่มงาน <span class="text-danger">*</span></label>
                            <input type="datetime-local" v-model="editingTask.start_date" class="form-control" :class="{'is-invalid': attemptSave && !editingTask.start_date}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-danger fw-bold">กำหนดส่ง (Deadline) <span class="text-danger">*</span></label>
                            <input type="datetime-local" v-model="editingTask.due_date" class="form-control" :class="{'is-invalid': attemptSave && !editingTask.due_date}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">ผู้รับผิดชอบ <span class="text-danger">*</span></label>
                            <div class="user-select-container" :class="{'border-danger': attemptSave && editingTask.assigned_to.length===0}">
                                <div v-for="u in users" :key="u.id" class="form-check">
                                    <input class="form-check-input" type="checkbox" :value="u.id" v-model="editingTask.assigned_to" :id="'user'+u.id">
                                    <label class="form-check-label" :for="'user'+u.id">
                                        {{ u.name }} <small class="text-muted">({{ u.department }})</small>
                                    </label>
                                </div>
                            </div>
                            <div v-if="attemptSave && editingTask.assigned_to.length===0" class="text-danger small mt-1">ต้องเลือกอย่างน้อย 1 คน</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">ความเร่งด่วน</label>
                            <select v-model="editingTask.priority" class="form-select">
                                <option value="normal">ปกติ</option>
                                <option value="urgent">ด่วนมาก</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label"><i class="bi bi-paperclip"></i> แนบไฟล์</label>
                            <input type="file" @change="(e) => handleFileUpload(e, 'task')" class="form-control" :disabled="uploading">
                            <small class="text-muted" v-if="uploading">กำลังอัปโหลด...</small>
                            <div class="mt-2" v-if="editingTask.files && editingTask.files.length > 0">
                                <div v-for="(file, index) in editingTask.files" :key="index" class="file-attachment">
                                    <a :href="file.url" target="_blank">{{ file.name }}</a>
                                    <i class="bi bi-x-circle text-danger ms-1" style="cursor:pointer;" @click="removeFile(index)"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" @click="saveTask" :disabled="uploading">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail & Chat Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" v-if="activeTask">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">
                        {{ activeTask.title }} 
                        <span v-if="activeTask.priority=='urgent'" class="badge bg-danger ms-2">Urgent</span>
                        <span v-if="activeTask.is_revision" class="badge bg-primary ms-2">Revision</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-7 border-end">
                            <h6>รายละเอียด:</h6>
                            <p class="text-break">{{ activeTask.description }}</p>
                            
                            <div class="row mb-3 bg-white p-3 border rounded shadow-sm mx-1">
                                <div class="col-6 mb-2"><strong>เริ่มงาน:</strong> <br>{{ formatDateTime(activeTask.start_date) }}</div>
                                <div class="col-6 mb-2 text-danger"><strong>กำหนดส่ง:</strong> <br>{{ formatDateTime(activeTask.due_date) }}</div>
                                
                                <div class="col-12 text-muted small mb-2" v-if="activeTask.is_revision && activeTask.original_due_date">
                                    (Original Deadline: {{ formatDateTime(activeTask.original_due_date) }})
                                </div>

                                <div class="col-12" v-if="activeTask.status === 'completed' && activeTask.completed_at">
                                    <strong class="text-success">เสร็จสิ้นเมื่อ:</strong> {{ formatDateTime(activeTask.completed_at) }}
                                </div>
                                <div class="col-12 mt-2"><strong>ผู้รับงาน:</strong> {{ getAssignedNames(activeTask.assigned_to) }}</div>
                            </div>

                            <div v-if="activeTask.files && activeTask.files.length > 0" class="mb-3">
                                <h6><i class="bi bi-paperclip"></i> ไฟล์แนบ:</h6>
                                <div>
                                    <span v-for="(file, idx) in activeTask.files" :key="idx" class="file-attachment">
                                        <a :href="file.url" target="_blank" class="text-decoration-none">{{ file.name }}</a>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card bg-light p-3 mb-3 border-0">
                                <label class="form-label fw-bold">อัปเดตสถานะงาน:</label>
                                <div class="input-group mb-2">
                                    <select v-model="tempStatus" class="form-select">
                                        <option value="pending">รอดำเนินการ</option>
                                        <option value="in_progress">กำลังดำเนินการ</option>
                                        <option value="completed">เสร็จสิ้น</option>
                                    </select>
                                    <button @click="updateStatusManual" class="btn btn-success"><i class="bi bi-check-lg"></i> บันทึกสถานะ</button>
                                </div>
                                <button v-if="activeTask.status === 'completed' && currentUser.role === 'manager'" @click="requestRevision" class="btn btn-outline-danger w-100">
                                    <i class="bi bi-arrow-counterclockwise"></i> สั่งแก้งาน (Revise)
                                </button>
                            </div>

                            <!-- Updated Revision History Table -->
                            <div class="card border-warning mb-3" v-if="activeTask.revision_history && activeTask.revision_history.length > 0">
                                <div class="card-header bg-warning text-dark fw-bold"><i class="bi bi-clock-history"></i> ประวัติการแก้ไข</div>
                                <div class="card-body p-0">
                                    <table class="table table-sm mb-0 table-striped">
                                        <thead><tr><th>รอบที่</th><th>สั่งแก้เมื่อ</th><th>กำหนดส่ง</th><th>เสร็จสิ้นเมื่อ</th></tr></thead>
                                        <tbody>
                                            <tr v-for="(rev, idx) in activeTask.revision_history" :key="idx">
                                                <td>{{ rev.round }}</td>
                                                <td>{{ formatDateTime(rev.requested_at) }}</td>
                                                <td>{{ formatDateTime(rev.due_date) }}</td>
                                                <td>
                                                    <span v-if="rev.finished_at" class="text-success">{{ formatDateTime(rev.finished_at) }}</span>
                                                    <span v-else class="text-muted">กำลังดำเนินการ</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div v-if="activeTask.evaluation" class="alert alert-success">
                                <h6><i class="bi bi-trophy-fill text-warning"></i> ผลการประเมิน ({{ getTotalScore(activeTask.evaluation) }}/20)</h6>
                                <div class="row g-2">
                                    <div class="col-6 d-flex justify-content-between">
                                        <span>Speed:</span> 
                                        <div class="star-display"><i v-for="n in 5" :class="['bi', n <= activeTask.evaluation.speed ? 'bi-star-fill active' : 'bi-star-fill']"></i></div>
                                    </div>
                                    <div class="col-6 d-flex justify-content-between">
                                        <span>Quality:</span>
                                        <div class="star-display"><i v-for="n in 5" :class="['bi', n <= activeTask.evaluation.quality ? 'bi-star-fill active' : 'bi-star-fill']"></i></div>
                                    </div>
                                    <div class="col-6 d-flex justify-content-between">
                                        <span>Creativity:</span>
                                        <div class="star-display"><i v-for="n in 5" :class="['bi', n <= activeTask.evaluation.creativity ? 'bi-star-fill active' : 'bi-star-fill']"></i></div>
                                    </div>
                                    <div class="col-6 d-flex justify-content-between">
                                        <span>Urgency:</span>
                                        <div class="star-display"><i v-for="n in 5" :class="['bi', n <= (activeTask.evaluation.urgency||0) ? 'bi-star-fill active' : 'bi-star-fill']"></i></div>
                                    </div>
                                </div>
                                <div class="mt-2 pt-2 border-top"><strong>Note:</strong> {{ activeTask.evaluation.note || '-' }}</div>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <h6><i class="bi bi-chat-dots"></i> พูดคุย / รายงานผล</h6>
                            <div class="chat-box mb-2" id="chatContainer">
                                <div v-for="msg in activeChat" :key="msg.id" :class="['chat-message', msg.user_id === currentUser.id ? 'chat-mine' : 'chat-other']">
                                    <small class="fw-bold d-block">{{ getUserName(msg.user_id) }}</small>
                                    <span style="white-space: pre-wrap;">{{ msg.message }}</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="text" v-model="newMessage" @keyup.enter="sendMessage" class="form-control" placeholder="พิมพ์ข้อความ...">
                                <button @click="sendMessage" class="btn btn-primary"><i class="bi bi-send"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluation Modal -->
    <div class="modal fade" id="evalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" v-if="evalData">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">ประเมินผลงาน (20 คะแนน)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex justify-content-between align-items-center border-bottom pb-2" v-for="crit in ['speed','quality','creativity','urgency']" :key="crit">
                        <label class="fw-bold text-capitalize">{{ crit === 'urgency' ? 'Urgency (งานด่วน)' : crit }}</label>
                        <div class="d-flex align-items-center">
                            <div class="star-rating me-2">
                                <i v-for="n in 5" :key="crit+n" @click="evalData[crit] = n" :class="['bi', n <= evalData[crit] ? 'bi-star-fill active' : 'bi-star']"></i>
                            </div>
                            <span class="fw-bold text-muted">({{ evalData[crit] || 0 }})</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label>ความคิดเห็นเพิ่มเติม (Note)</label>
                        <textarea v-model="evalData.note" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="submitEvaluation" class="btn btn-primary w-100">บันทึกผลประเมิน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ editingUser.id ? 'แก้ไขผู้ใช้งาน' : 'เพิ่มผู้ใช้งานใหม่' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label>ชื่อ-นามสกุล</label><input v-model="editingUser.name" class="form-control"></div>
                    <div class="mb-2"><label>Username</label><input v-model="editingUser.username" class="form-control"></div>
                    <div class="mb-2"><label>Password</label><input v-model="editingUser.password" class="form-control" type="password"></div>
                    
                    <div class="mb-2">
                        <label>Role</label>
                        <select v-model="editingUser.role" class="form-select">
                            <option value="team">Team Member</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>

                    <div class="mb-2" v-if="editingUser.role !== 'manager'">
                        <label>แผนก</label>
                        <select v-model="editingUser.department" class="form-select">
                            <option v-for="d in departmentsList" :value="d">{{d}}</option>
                        </select>
                    </div>
                    <div v-else class="mb-2">
                        <label>แผนก</label>
                        <input type="text" class="form-control" value="General (All Access)" disabled>
                    </div>

                </div>
                <div class="modal-footer">
                    <button @click="saveUser" class="btn btn-primary">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Management Modal -->
    <div class="modal fade" id="deptModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">จัดการแผนก</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label>ชื่อแผนก</label>
                    <input v-model="tempDeptName" class="form-control" placeholder="เช่น IT, HR, Marketing">
                </div>
                <div class="modal-footer">
                    <button @click="saveDept" class="btn btn-primary">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Upload/Edit Modal -->
    <div class="modal fade" id="docModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ newDoc.id ? 'แก้ไขสิทธิ์เอกสาร' : 'อัปโหลดเอกสาร' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label>ชื่อเอกสาร</label><input v-model="newDoc.title" class="form-control" :disabled="newDoc.id"></div>
                    <div class="mb-3">
                        <label>ประเภท</label>
                        <select v-model="newDoc.category" class="form-select" :disabled="newDoc.id">
                            <option value="JD">Job Description</option>
                            <option value="WI">Work Instruction</option>
                            <option value="SOP">SOP</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>แผนกที่เข้าถึงได้ (หลัก)</label>
                        <select v-model="newDoc.department" class="form-select">
                            <option value="General">General (ทุกคนเห็น)</option>
                            <option v-for="d in departmentsList" :value="d">{{d}}</option>
                        </select>
                    </div>
                    <!-- New feature: Assign to specific user -->
                    <div class="mb-3 p-3 bg-light rounded border">
                        <label class="fw-bold mb-2">ระบุสิทธิ์รายบุคคล (Option)</label>
                        <select v-model="newDoc.target_user_id" class="form-select">
                            <option :value="null">-- ไม่ระบุ (ใช้สิทธิ์ตามแผนก) --</option>
                            <option v-for="u in users" :key="u.id" :value="u.id">{{ u.name }} ({{u.department}})</option>
                        </select>
                        <small class="text-muted d-block mt-1">* หากระบุ จะมีเพียงคนนี้และ Manager เท่านั้นที่เห็น</small>
                    </div>

                    <div class="mb-3" v-if="!newDoc.id">
                        <label>ไฟล์เอกสาร</label>
                        <input type="file" @change="(e) => handleFileUpload(e, 'doc')" class="form-control">
                        <small v-if="uploading" class="text-primary">Uploading...</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="saveDoc" class="btn btn-primary" :disabled="uploading || (!newDoc.id && !newDoc.url)">{{ newDoc.id ? 'บันทึกการแก้ไข' : 'อัปโหลด' }}</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
    const { createApp, ref, computed, reactive, onMounted, nextTick, watch } = Vue;
    const { createClient } = supabase;

    /* --- Configuration --- */
    const supabaseUrl = 'https://obnndehnwjqyocxugbbq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ibm5kZWhud2pxeW9jeHVnYmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDQyNzIsImV4cCI6MjA4MTE4MDI3Mn0.lxix9WGTOFvvVwE8QjytNaFsH1mjqC9ncF1Z_ggmAyg';
    const _supabase = createClient(supabaseUrl, supabaseKey);

    const savedSessionInit = localStorage.getItem('odf_session');
    const initialUser = savedSessionInit ? JSON.parse(savedSessionInit) : null;

    createApp({
        setup() {
            // Global UI State
            const loading = ref(false);
            const isSidebarOpen = ref(true);
            const currentView = ref('dashboard');
            
            // User Data
            const currentUser = ref(initialUser); 
            const loginForm = reactive({ username: '', password: '' });
            const users = ref([]);
            const editingUser = ref({});
            
            // Department Management
            const departmentsList = ref(['General', 'IT', 'Marketing', 'HR', 'Accounting', 'Sales']); 
            const tempDeptName = ref('');
            
            // Task Data
            const tasks = ref([]);
            const filterUser = ref("");
            const filterStatus = ref("");
            const dashboardFilter = ref(null); 
            const dashboardDetailFilter = ref(''); 
            const attemptSave = ref(false); 
            
            // Active Items
            const activeTask = ref(null);
            const tempStatus = ref(""); 
            const activeChat = ref([]);
            const newMessage = ref("");
            const editingTask = ref({ files: [] });
            const uploading = ref(false);
            
            // Evaluation
            const evalData = ref(null);
            const reviewMode = ref('pending');

            // KPI
            const kpiStartDate = ref(new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10));
            const kpiEndDate = ref(new Date().toISOString().slice(0,10));
            const kpiSelectedUser = ref(null); 
            const kpiSelectedMonth = ref(new Date().getMonth() + 1);
            const kpiSelectedYear = ref(new Date().getFullYear());
            let kpiChartInstance = null;

            // SOP
            const documents = ref([]);
            const documentReads = ref([]);
            const sopTab = ref('JD');
            const sopFilterDept = ref('');
            const newDoc = ref({ title: '', category: 'SOP', department: 'General', url: '', target_user_id: null });

            // Modals references
            let taskModal, detailModal, evalModal, userModal, docModal, deptModal;

            // --- Authentication ---
            onMounted(async () => {
                if (currentUser.value) {
                    await initData();
                }
                const savedDepts = localStorage.getItem('odf_depts');
                if(savedDepts) departmentsList.value = JSON.parse(savedDepts);
                
                updateKpiDateFromDropdown();
            });

            const login = async () => {
                loading.value = true;
                const { data } = await _supabase.from('users').select('*').eq('username', loginForm.username).eq('password', loginForm.password).single();
                if (data) {
                    currentUser.value = data;
                    localStorage.setItem('odf_session', JSON.stringify(data));
                    await initData();
                } else {
                    alert('Username/Password ไม่ถูกต้อง');
                }
                loading.value = false;
            };
            
            const logout = () => { 
                localStorage.removeItem('odf_session');
                location.reload(); 
            };
            const toggleSidebar = () => isSidebarOpen.value = !isSidebarOpen.value;

            // --- Initial Data Load ---
            const initData = async () => {
                await fetchUsers();
                await fetchTasks();
                await fetchDocs();
            };
            
            const fetchUsers = async () => {
                const { data } = await _supabase.from('users').select('*');
                users.value = data || [];
            };

            const fetchTasks = async () => {
                const { data, error } = await _supabase.from('tasks').select('*').order('created_at', { ascending: false });
                if (error) console.error("Fetch Tasks Error:", error);
                tasks.value = data || [];
            };
            
            // --- Helper: Check assignments generic type ---
            const checkAssignment = (assignedArr, userId) => {
                if (!assignedArr) return false;
                // Use loose equality to allow string/int mismatch just in case, but safe
                return assignedArr.some(id => id == userId);
            };

            // --- Dashboard Logic ---
            const isOverdue = (task) => {
                return task.status !== 'completed' && new Date(task.due_date) < new Date();
            };

            const dashboardStats = computed(() => {
                let scopeTasks = tasks.value;
                if (currentUser.value.role === 'team') {
                    scopeTasks = scopeTasks.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                }

                return {
                    total: scopeTasks.length,
                    pending: scopeTasks.filter(t => t.status === 'pending').length,
                    inProgress: scopeTasks.filter(t => t.status === 'in_progress').length,
                    completed: scopeTasks.filter(t => t.status === 'completed').length,
                    urgent: scopeTasks.filter(t => t.priority === 'urgent' && t.status !== 'completed').length,
                    revision: scopeTasks.filter(t => t.is_revision && t.status !== 'completed').length,
                    overdue: scopeTasks.filter(t => isOverdue(t)).length
                };
            });

            const setDashboardDetailFilter = (type) => {
                dashboardDetailFilter.value = type;
            };

            const getDashboardFilterName = (filter) => {
                if(!filter) return 'ทั้งหมด';
                const map = { urgent: 'งานด่วน', revision: 'งานแก้ (Revision)', overdue: 'ล่าช้า', pending: 'รอดำเนินการ', in_progress: 'กำลังทำ', completed: 'เสร็จสิ้น' };
                return map[filter] || filter;
            };

            const dashboardDetailTasks = computed(() => {
                let res = tasks.value;
                if (currentUser.value.role === 'team') {
                    res = res.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                }

                if (dashboardDetailFilter.value === 'overdue') res = res.filter(t => isOverdue(t));
                else if (dashboardDetailFilter.value === 'urgent') res = res.filter(t => t.priority === 'urgent' && t.status !== 'completed');
                else if (dashboardDetailFilter.value === 'revision') res = res.filter(t => t.is_revision && t.status !== 'completed');
                else if (dashboardDetailFilter.value) res = res.filter(t => t.status === dashboardDetailFilter.value);
                
                return res;
            });

            const filteredTasks = computed(() => {
                let res = tasks.value;
                
                if (currentView.value === 'my_tasks') {
                    res = res.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                } 
                
                // Add Revisions View Logic
                if (currentView.value === 'revisions') {
                    res = res.filter(t => t.is_revision === true);
                    if (currentUser.value.role === 'team') {
                        res = res.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                    }
                }
                
                if (filterUser.value) {
                    res = res.filter(t => checkAssignment(t.assigned_to, filterUser.value));
                }

                if (filterStatus.value) {
                    if (filterStatus.value === 'urgent') res = res.filter(t => t.priority === 'urgent');
                    else if (filterStatus.value === 'overdue') res = res.filter(t => isOverdue(t));
                    else res = res.filter(t => t.status === filterStatus.value);
                }

                return res;
            });

            // --- Tasks Operations ---
            const openTaskModal = (task = null) => {
                attemptSave.value = false;
                taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                const formatForInput = (dateStr) => dateStr ? new Date(dateStr).toISOString().slice(0, 16) : '';
                if (task) {
                    editingTask.value = { ...task, start_date: formatForInput(task.start_date), due_date: formatForInput(task.due_date), files: task.files || [] };
                } else {
                    editingTask.value = { 
                        title: '', description: '', assigned_to: [], priority: 'normal', 
                        status: 'pending', created_by: currentUser.value.id, files: [], start_date: '', due_date: '' 
                    };
                }
                taskModal.show();
            };

            const saveTask = async () => {
                attemptSave.value = true;
                const t = editingTask.value;
                
                if (!t.title || !t.description || !t.start_date || !t.due_date || t.assigned_to.length === 0) {
                    return; 
                }

                const payload = { ...t };
                
                // FIX: Force integer array to prevent Type Mismatch with DB
                if(payload.assigned_to) {
                     if(!Array.isArray(payload.assigned_to)) payload.assigned_to = [payload.assigned_to];
                     payload.assigned_to = payload.assigned_to.map(id => parseInt(id));
                }

                if (payload.start_date) payload.start_date = new Date(payload.start_date).toISOString();
                if (payload.due_date) payload.due_date = new Date(payload.due_date).toISOString();
                
                // Set Original Dates
                if (!payload.id || !payload.original_start_date) {
                    payload.original_start_date = payload.start_date;
                }
                if (!payload.id || !payload.original_due_date) {
                    payload.original_due_date = payload.due_date;
                }

                if (payload.status === 'completed' && !payload.completed_at) {
                    payload.completed_at = new Date().toISOString();
                }

                // FIX: Add Error Handling to alert user if DB schema is missing
                let error = null;
                if (payload.id) {
                    const res = await _supabase.from('tasks').update(payload).eq('id', payload.id);
                    error = res.error;
                } else {
                    const res = await _supabase.from('tasks').insert([payload]);
                    error = res.error;
                }

                if (error) {
                    alert("บันทึกไม่สำเร็จ: " + error.message + "\n(กรุณาตรวจสอบว่าได้รันคำสั่ง SQL เพิ่ม Column แล้วหรือยัง)");
                    return;
                }

                await fetchTasks();
                taskModal.hide();
                attemptSave.value = false;
            };

            const deleteTask = async (id) => {
                if (confirm('ยืนยันการลบงานนี้?')) {
                    await _supabase.from('tasks').delete().eq('id', id);
                    await fetchTasks();
                }
            };

            const openTaskDetail = (task) => {
                activeTask.value = JSON.parse(JSON.stringify(task)); 
                tempStatus.value = task.status; 
                detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                detailModal.show();
                fetchChat(task.id);
            };
            
            // Revised Update Status Logic
            const updateStatusManual = async () => {
                if(activeTask.value.status === tempStatus.value) return;
                
                if(confirm('ยืนยันเปลี่ยนสถานะเป็น: ' + getStatusText(tempStatus.value) + '?')) {
                    const updates = { status: tempStatus.value, updated_at: new Date() };
                    
                    if (tempStatus.value === 'completed') {
                        updates.completed_at = new Date().toISOString();
                        
                        // 1. Set first_completed_at if not set
                        if (!activeTask.value.first_completed_at) {
                            updates.first_completed_at = new Date().toISOString();
                        }

                        // 2. If it is a revision, mark the last history item as finished
                        if (activeTask.value.is_revision && activeTask.value.revision_history?.length > 0) {
                            const history = [...activeTask.value.revision_history];
                            const lastIndex = history.length - 1;
                            history[lastIndex].finished_at = new Date().toISOString();
                            updates.revision_history = history;
                        }
                    }
                    
                    activeTask.value.status = tempStatus.value;
                    await _supabase.from('tasks').update(updates).eq('id', activeTask.value.id);
                    await fetchTasks(); 
                    alert('บันทึกสถานะเรียบร้อย');
                }
            };

            // NEW REVISION LOGIC (JSON Based)
            const requestRevision = async () => {
                const newDateStr = prompt("กรุณาระบุวันกำหนดส่งงานใหม่ (YYYY-MM-DD HH:MM)", formatDateTime(new Date(new Date().getTime() + 24*60*60*1000)));
                if (!newDateStr) return; 

                const newDueDate = new Date(newDateStr);
                const validDate = !isNaN(newDueDate.getTime()) ? newDueDate : new Date(new Date().getTime() + 86400000);

                if (!confirm("ยืนยันสั่งแก้งาน? \nกำหนดส่งใหม่: " + formatDateTime(validDate.toISOString()))) return;
                
                const currentHistory = activeTask.value.revision_history || [];
                const newRevisionEntry = {
                    round: currentHistory.length + 1,
                    requested_at: new Date().toISOString(),
                    finished_at: null,
                    due_date: validDate.toISOString(),
                    note: 'Requested by Manager'
                };
                const updatedHistory = [...currentHistory, newRevisionEntry];

                const updates = { 
                    status: 'pending', 
                    is_revision: true, 
                    updated_at: new Date(),
                    start_date: new Date().toISOString(), 
                    due_date: validDate.toISOString(),
                    revision_history: updatedHistory
                };
                
                activeTask.value.status = 'pending';
                activeTask.value.is_revision = true;
                activeTask.value.due_date = validDate.toISOString();
                activeTask.value.start_date = new Date().toISOString();
                activeTask.value.revision_history = updatedHistory;
                tempStatus.value = 'pending'; 
                
                const { error } = await _supabase.from('tasks').update(updates).eq('id', activeTask.value.id);
                if (error) alert("Error saving revision: " + error.message);

                await fetchChat(activeTask.value.id); 
                await fetchTasks(); 
            };

            // --- Chat ---
            const fetchChat = async (taskId) => {
                const { data } = await _supabase.from('comments').select('*').eq('task_id', taskId).order('created_at', { ascending: true });
                activeChat.value = data || [];
                nextTick(() => { 
                    const el = document.getElementById('chatContainer'); 
                    if(el) el.scrollTop = el.scrollHeight; 
                });
            };
            const sendMessage = async () => {
                if (!newMessage.value.trim()) return;
                await _supabase.from('comments').insert([{ task_id: activeTask.value.id, user_id: currentUser.value.id, message: newMessage.value }]);
                newMessage.value = "";
                await fetchChat(activeTask.value.id);
            };

            // --- Evaluation ---
            const reviewListTasks = computed(() => {
                if (reviewMode.value === 'pending') {
                    return tasks.value.filter(t => t.status === 'completed' && !t.evaluation);
                } else {
                    return tasks.value.filter(t => t.status === 'completed' && t.evaluation);
                }
            });

            const pendingReviewCount = computed(() => tasks.value.filter(t => t.status === 'completed' && !t.evaluation).length);

            const openEvaluation = (task) => {
                activeTask.value = task;
                evalData.value = task.evaluation || { speed: 5, quality: 5, creativity: 5, urgency: 5, note: '' };
                evalModal = new bootstrap.Modal(document.getElementById('evalModal'));
                evalModal.show();
            };

            const submitEvaluation = async () => {
                await _supabase.from('tasks').update({ evaluation: evalData.value }).eq('id', activeTask.value.id);
                evalModal.hide();
                await fetchTasks();
            };

            const getTotalScore = (ev) => ev ? (parseInt(ev.speed)+parseInt(ev.quality)+parseInt(ev.creativity)+parseInt(ev.urgency||0)) : 0;

            // --- KPI Logic ---
            const updateKpiDateFromDropdown = () => {
                const y = parseInt(kpiSelectedYear.value);
                const m = parseInt(kpiSelectedMonth.value);
                const start = new Date(y, m - 1, 1); 
                const end = new Date(y, m, 0); 
                
                const toIsoDate = (d) => {
                    const offset = d.getTimezoneOffset() * 60000;
                    return new Date(d.getTime() - offset).toISOString().slice(0,10);
                }

                kpiStartDate.value = toIsoDate(start);
                kpiEndDate.value = toIsoDate(end);
            };

            const topRatedTasks = computed(() => {
                const start = new Date(kpiStartDate.value);
                const end = new Date(kpiEndDate.value);
                end.setHours(23,59,59);

                let list = tasks.value.filter(t => 
                    t.status === 'completed' && t.evaluation &&
                    new Date(t.updated_at || t.created_at) >= start &&
                    new Date(t.updated_at || t.created_at) <= end
                );

                if (currentView.value === 'my_kpi') {
                    list = list.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                } else if (currentView.value === 'one_on_one' && kpiSelectedUser.value) {
                    list = list.filter(t => checkAssignment(t.assigned_to, kpiSelectedUser.value));
                }
                
                return list.sort((a,b) => getTotalScore(b.evaluation) - getTotalScore(a.evaluation));
            });

            const calculateKPI = () => {
                const start = new Date(kpiStartDate.value);
                const end = new Date(kpiEndDate.value);
                end.setHours(23,59,59);

                let relevantTasks = tasks.value.filter(t => 
                    t.status === 'completed' && t.evaluation && 
                    new Date(t.updated_at) >= start && new Date(t.updated_at) <= end
                );

                let targetUsers = users.value;
                if (currentView.value === 'my_kpi') {
                     targetUsers = [currentUser.value];
                } else if (currentView.value === 'one_on_one') {
                    if(!kpiSelectedUser.value) {
                        if (kpiChartInstance) kpiChartInstance.destroy();
                        return;
                    }
                    targetUsers = users.value.filter(u => u.id == kpiSelectedUser.value);
                }

                const stats = {};
                targetUsers.forEach(u => stats[u.name] = { total: 0, count: 0 });

                relevantTasks.forEach(t => {
                    t.assigned_to.forEach(uid => {
                        const uName = getUserName(uid);
                        if (stats[uName]) {
                            stats[uName].total += getTotalScore(t.evaluation);
                            stats[uName].count++;
                        }
                    });
                });

                const labels = [];
                const data = [];
                for (const name in stats) {
                    if (currentView.value === 'kpi') {
                        if (stats[name].count > 0) {
                            labels.push(name);
                            data.push((stats[name].total / stats[name].count).toFixed(1));
                        }
                    } else {
                        if (stats[name]) {
                            labels.push(name);
                            data.push(stats[name].count ? (stats[name].total / stats[name].count).toFixed(1) : 0);
                        }
                    }
                }

                if (kpiChartInstance) kpiChartInstance.destroy();
                const ctx = document.getElementById('kpiChart');
                if (ctx) {
                    kpiChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'คะแนนเฉลี่ย (เต็ม 20)',
                                data: data,
                                backgroundColor: '#3498db',
                                borderRadius: 5
                            }]
                        },
                        options: { 
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, max: 20 } } 
                        }
                    });
                }
            };

            Vue.watch(currentView, (newVal) => {
                if(['kpi', 'my_kpi', 'one_on_one'].includes(newVal)) setTimeout(calculateKPI, 500);
            });

            // --- Departments Management ---
            const openDeptModal = (deptName = '', idx = -1) => {
                tempDeptName.value = deptName;
                tempDeptName.idx = idx; 
                deptModal = new bootstrap.Modal(document.getElementById('deptModal'));
                deptModal.show();
            };
            const saveDept = () => {
                if(!tempDeptName.value) return;
                
                if (tempDeptName.idx !== undefined && tempDeptName.idx !== -1) {
                    departmentsList.value[tempDeptName.idx] = tempDeptName.value;
                } else {
                    departmentsList.value.push(tempDeptName.value);
                }
                localStorage.setItem('odf_depts', JSON.stringify(departmentsList.value));
                deptModal.hide();
            };
            const deleteDept = (idx) => {
                if(confirm('ลบแผนกนี้?')) {
                    departmentsList.value.splice(idx, 1);
                    localStorage.setItem('odf_depts', JSON.stringify(departmentsList.value));
                }
            };

            // --- User Management ---
            const openUserModal = (u = null) => {
                editingUser.value = u ? { ...u } : { name: '', username: '', password: '', role: 'team', department: departmentsList.value[0] || 'General' };
                userModal = new bootstrap.Modal(document.getElementById('userModal'));
                userModal.show();
            };

            watch(() => editingUser.value.role, (newRole) => {
                if (newRole === 'manager') {
                    editingUser.value.department = 'General';
                }
            });

            const saveUser = async () => {
                const u = editingUser.value;
                if (u.id) await _supabase.from('users').update(u).eq('id', u.id);
                else await _supabase.from('users').insert([u]);
                await fetchUsers();
                userModal.hide();
            };
            
            const deleteUser = async (id) => {
                if(confirm('ยืนยันลบผู้ใช้งานนี้?')) {
                    await _supabase.from('users').delete().eq('id', id);
                    await fetchUsers();
                }
            };

            // --- File Upload ---
            const handleFileUpload = async (event, type) => {
                const file = event.target.files[0];
                if (!file) return;
                uploading.value = true;
                const fileName = `${Date.now()}_${file.name}`;
                
                const { error } = await _supabase.storage.from('task-files').upload(fileName, file);
                if (error) { alert('Upload failed: ' + error.message); uploading.value = false; return; }
                
                const { data } = _supabase.storage.from('task-files').getPublicUrl(fileName);
                const publicUrl = data.publicUrl;

                if (type === 'task') {
                    editingTask.value.files.push({ name: file.name, url: publicUrl });
                } else if (type === 'doc') {
                    newDoc.value.url = publicUrl;
                    newDoc.value.title = newDoc.value.title || file.name;
                }
                uploading.value = false;
            };

            const removeFile = (index) => editingTask.value.files.splice(index, 1);

            // --- SOP / Documents ---
            const fetchDocs = async () => {
                const { data, error } = await _supabase.from('documents').select('*');
                if (!error) documents.value = data; 
                fetchDocReads(); 
            };

            const fetchDocReads = async () => {
                const { data, error } = await _supabase.from('document_reads').select('*');
                if (!error) documentReads.value = data || [];
            };

            const filteredDocs = computed(() => {
                if (sopTab.value === 'MANAGE') return []; 
                
                let docs = documents.value.filter(d => d.category === sopTab.value);
                
                if (currentUser.value.role !== 'manager') {
                    docs = docs.filter(d => {
                        if (d.target_user_id) return d.target_user_id == currentUser.value.id; // Loose equality for safety
                        return d.department === 'General' || d.department === currentUser.value.department;
                    });
                }

                if (sopFilterDept.value) {
                    docs = docs.filter(d => d.department === sopFilterDept.value);
                }

                return docs;
            });

            const hasUserRead = (docId, userId) => {
                return documentReads.value.some(r => r.doc_id === docId && r.user_id == userId);
            };

            const markDocRead = async (docId) => {
                const { error } = await _supabase.from('document_reads').insert([{ user_id: currentUser.value.id, doc_id: docId }]);
                if(!error) {
                    documentReads.value.push({ user_id: currentUser.value.id, doc_id: docId });
                }
            };

            const openDocModal = () => {
                newDoc.value = { title: '', category: 'SOP', department: 'General', url: '', target_user_id: null };
                docModal = new bootstrap.Modal(document.getElementById('docModal'));
                docModal.show();
            };
            
            const openDocEdit = (doc) => {
                newDoc.value = { ...doc }; 
                docModal = new bootstrap.Modal(document.getElementById('docModal'));
                docModal.show();
            };

            const saveDoc = async () => {
                if (newDoc.value.id) {
                    await _supabase.from('documents').update(newDoc.value).eq('id', newDoc.value.id);
                } else {
                    const { error } = await _supabase.from('documents').insert([newDoc.value]);
                    if(error) alert('Error: ' + error.message);
                }
                await fetchDocs();
                docModal.hide();
            };

            const deleteDoc = async (id) => {
                if(confirm('ลบเอกสาร?')) {
                    await _supabase.from('documents').delete().eq('id', id);
                    await fetchDocs();
                }
            };

            // --- Helpers ---
            const getAssignedNames = (ids) => {
                if (!ids || ids.length === 0) return "ไม่ระบุ";
                const arr = Array.isArray(ids) ? ids : [ids];
                // Handle generic ID types (int/string)
                return arr.map(id => users.value.find(u => u.id == id)?.name || 'Unknown').join(', ');
            };
            const getUserName = (id) => users.value.find(u => u.id == id)?.name || 'Unknown';
            const getStatusBadge = (status) => {
                const map = { pending: 'badge bg-warning text-dark', in_progress: 'badge bg-info', completed: 'badge bg-success' };
                return map[status] || 'badge bg-secondary';
            };
            const getStatusText = (status) => {
                const map = { pending: 'รอดำเนินการ', in_progress: 'กำลังทำ', completed: 'เสร็จสิ้น' };
                return map[status] || status;
            };
            const formatDateTime = (dateStr) => {
                if (!dateStr) return "-";
                const d = new Date(dateStr);
                return d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            };

            return {
                currentUser, loginForm, loading, login, logout, 
                currentView, isSidebarOpen, toggleSidebar,
                // Dashboard
                dashboardStats, dashboardDetailFilter, setDashboardDetailFilter, getDashboardFilterName, dashboardDetailTasks, isOverdue,
                // Tasks
                tasks, filteredTasks, filterUser, filterStatus, attemptSave,
                openTaskModal, editingTask, saveTask, deleteTask, uploading, handleFileUpload, removeFile,
                openTaskDetail, activeTask, tempStatus, updateStatusManual, requestRevision,
                activeChat, newMessage, sendMessage,
                // Review
                reviewListTasks, pendingReviewCount, openEvaluation, evalData, submitEvaluation, reviewMode,
                // Users & Depts
                openUserModal, editingUser, saveUser, deleteUser, users,
                departmentsList, openDeptModal, saveDept, deleteDept, tempDeptName,
                // SOP
                documents, sopTab, filteredDocs, newDoc, openDocModal, openDocEdit, saveDoc, deleteDoc, sopFilterDept, hasUserRead, markDocRead,
                // KPI
                kpiStartDate, kpiEndDate, calculateKPI, topRatedTasks, getTotalScore, kpiSelectedUser,
                kpiSelectedMonth, kpiSelectedYear, updateKpiDateFromDropdown,
                // Util
                getAssignedNames, getStatusBadge, getStatusText, formatDateTime, getUserName, getTotalScore
            };
        }
    }).mount('#app');
</script>

</body>
</html>

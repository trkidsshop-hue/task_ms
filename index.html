<!-- --- START OF FILE Task_MS_V.2.0.html --- -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODF Task Manager</title>
    
    <!-- Favicon (Simulated with Data URI for ODF) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ODF</text></svg>">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts (Prompt) -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js for KPI -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f4f6f9; overflow-x: hidden; }
        
        /* Sidebar Styling */
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; transition: all 0.3s; position: relative; }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .nav-link span, 
        .sidebar.collapsed .user-info, 
        .sidebar.collapsed .sidebar-header span { display: none; }
        .sidebar.collapsed .sidebar-header { justify-content: center; }
        .sidebar.collapsed .nav-link { text-align: center; padding: 10px; }
        .sidebar.collapsed .nav-link i { font-size: 1.5rem; margin-right: 0 !important; }
        
        .nav-link { color: rgba(255,255,255,0.8); cursor: pointer; white-space: nowrap; margin-bottom: 5px;}
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.1); border-radius: 5px; }
        
        /* Card & UI */
        .card { border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; margin-bottom: 20px; transition: transform 0.2s; }
        .card-clickable:hover { transform: translateY(-5px); cursor: pointer; opacity: 0.9; }
        
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 20px; }
        .chat-box { height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 10px; padding: 15px; }
        .chat-message { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; }
        .chat-mine { background: #d1e7dd; margin-left: auto; }
        .chat-other { background: #e2e3e5; }
        .file-attachment { background: #e9ecef; padding: 5px 10px; border-radius: 5px; display: inline-block; margin-right: 5px; margin-bottom: 5px; font-size: 0.9em; }
        
        /* Star Rating */
        .star-rating i { font-size: 1.5rem; color: #ddd; cursor: pointer; transition: color 0.2s; }
        .star-rating i.active { color: #ffc107; }
        
        /* KPI Chart Container */
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* Modal Transition */
        .modal.fade .modal-dialog { transform: scale(0.9); transition: transform 0.3s ease-out; }
        .modal.show .modal-dialog { transform: scale(1); }
    </style>
</head>
<body>

<div id="app">
    <!-- ================== LOGIN PAGE ================== -->
    <div v-if="!currentUser" class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card p-5 shadow-lg" style="width: 400px;">
            <h3 class="text-center mb-4 text-primary fw-bold">ODF Task Manager</h3>
            <div class="mb-3">
                <label>Username</label>
                <input type="text" v-model="loginForm.username" class="form-control" placeholder="เช่น manager" @keyup.enter="login">
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" v-model="loginForm.password" class="form-control" placeholder="เช่น 1234" @keyup.enter="login">
            </div>
            <button @click="login" class="btn btn-primary w-100" :disabled="loading">
                <span v-if="loading" class="spinner-border spinner-border-sm"></span> เข้าสู่ระบบ
            </button>
            <small class="text-muted d-block text-center mt-3">Demo: manager / 1234 หรือ team1 / 1234</small>
        </div>
    </div>

    <!-- ================== MAIN APP ================== -->
    <div v-else class="d-flex">
        
        <!-- Sidebar -->
        <div :class="['sidebar d-flex flex-column flex-shrink-0 p-3', isSidebarOpen ? '' : 'collapsed']" style="width: 260px;">
            <div class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none sidebar-header justify-content-between w-100">
                <span class="fs-4 fw-bold"><i class="bi bi-grid-fill me-2"></i>ODF System</span>
                <i class="bi bi-list fs-4" style="cursor: pointer;" @click="toggleSidebar"></i>
            </div>
            <hr>
            <div class="mb-3 user-info">
                <small class="text-white-50">ผู้ใช้งาน: {{ currentUser.name }}</small><br>
                <span class="badge bg-info text-dark">{{ currentUser.role === 'manager' ? 'หัวหน้า' : 'ทีมงาน' }}</span>
                <div class="small text-white-50 mt-1">แผนก: {{ currentUser.department }}</div>
            </div>
            
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a @click="currentView = 'dashboard'" :class="['nav-link', currentView === 'dashboard' ? 'active' : '']" title="Dashboard">
                        <i class="bi bi-speedometer2 me-2"></i> <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a @click="currentView = 'my_tasks'" :class="['nav-link', currentView === 'my_tasks' ? 'active' : '']" title="งานของฉัน">
                        <i class="bi bi-person-check me-2"></i> <span>งานของฉัน</span>
                    </a>
                </li>
                <li>
                    <a @click="currentView = 'tasks'; dashboardFilter=null" :class="['nav-link', currentView === 'tasks' ? 'active' : '']" title="งานทั้งหมด">
                        <i class="bi bi-list-task me-2"></i> <span>งานทั้งหมด</span>
                    </a>
                </li>
                
                <!-- Manager Only Menus -->
                <div v-if="currentUser.role === 'manager'">
                    <hr class="text-white-50 my-2">
                    <li>
                        <a @click="currentView = 'review'" :class="['nav-link', currentView === 'review' ? 'active' : '']" title="รอประเมิน">
                            <i class="bi bi-star-half me-2"></i> <span>Review ({{ pendingReviewCount }})</span>
                        </a>
                    </li>
                    <li>
                        <a @click="currentView = 'kpi'" :class="['nav-link', currentView === 'kpi' ? 'active' : '']" title="KPI & Reports">
                            <i class="bi bi-graph-up-arrow me-2"></i> <span>KPI & Reports</span>
                        </a>
                    </li>
                    <li>
                        <a @click="currentView = 'users'" :class="['nav-link', currentView === 'users' ? 'active' : '']" title="จัดการทีม">
                            <i class="bi bi-people me-2"></i> <span>จัดการทีม</span>
                        </a>
                    </li>
                </div>

                <hr class="text-white-50 my-2">
                <li>
                    <a @click="currentView = 'sop'" :class="['nav-link', currentView === 'sop' ? 'active' : '']" title="SOP / WI / JD">
                        <i class="bi bi-folder2-open me-2"></i> <span>SOP / WI / JD</span>
                    </a>
                </li>
            </ul>
            <hr>
            <button @click="logout" class="btn btn-outline-light btn-sm w-100">
                <i class="bi bi-box-arrow-right"></i> <span v-if="isSidebarOpen">ออกจากระบบ</span>
            </button>
        </div>

        <!-- Content Area -->
        <div class="flex-grow-1 p-4" style="height: 100vh; overflow-y: auto;">
            
            <!-- Dashboard View -->
            <div v-if="currentView === 'dashboard'">
                <h2 class="mb-4">ภาพรวมงาน (Dashboard)</h2>
                
                <!-- Stats Cards (Clickable) -->
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <div @click="setDashboardFilter('')" class="card card-clickable bg-primary text-white p-3 h-100">
                            <h5>งานทั้งหมด</h5>
                            <h2 class="display-6">{{ dashboardStats.total }}</h2>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div @click="setDashboardFilter('urgent')" class="card card-clickable bg-danger text-white p-3 h-100">
                            <h5>งานด่วน</h5>
                            <h2 class="display-6">{{ dashboardStats.urgent }}</h2>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div @click="setDashboardFilter('overdue')" class="card card-clickable bg-secondary text-white p-3 h-100 position-relative">
                            <h5>ล่าช้า</h5>
                            <h2 class="display-6">{{ dashboardStats.overdue }}</h2>
                            <i class="bi bi-exclamation-triangle position-absolute top-0 end-0 m-2"></i>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div @click="setDashboardFilter('pending')" class="card card-clickable bg-warning text-dark p-3 h-100">
                            <h5>รอดำเนินการ</h5>
                            <h2 class="display-6">{{ dashboardStats.pending }}</h2>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div @click="setDashboardFilter('in_progress')" class="card card-clickable bg-info text-white p-3 h-100">
                            <h5>กำลังทำ</h5>
                            <h2 class="display-6">{{ dashboardStats.inProgress }}</h2>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div @click="setDashboardFilter('completed')" class="card card-clickable bg-success text-white p-3 h-100">
                            <h5>เสร็จสิ้น</h5>
                            <h2 class="display-6">{{ dashboardStats.completed }}</h2>
                        </div>
                    </div>
                </div>

                <!-- Urgent / Upcoming -->
                <div class="card p-4">
                    <h5 class="mb-3 text-danger"><i class="bi bi-fire"></i> งานด่วน / ใกล้กำหนดส่ง</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th>ชื่องาน</th><th>ผู้รับผิดชอบ</th><th>สถานะ</th><th>กำหนดส่ง</th></tr></thead>
                            <tbody>
                                <tr v-for="task in urgentTasks" :key="task.id">
                                    <td>
                                        {{ task.title }} 
                                        <span v-if="task.priority === 'urgent'" class="badge bg-danger">ด่วน</span>
                                        <span v-if="isOverdue(task)" class="badge bg-dark">ล่าช้า</span>
                                    </td>
                                    <td>{{ getAssignedNames(task.assigned_to) }}</td>
                                    <td><span :class="getStatusBadge(task.status)">{{ getStatusText(task.status) }}</span></td>
                                    <td :class="isOverdue(task) ? 'text-danger fw-bold' : ''">{{ formatDateTime(task.due_date) }}</td>
                                </tr>
                                <tr v-if="urgentTasks.length === 0"><td colspan="4" class="text-center">ไม่มีงานเร่งด่วน</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tasks View / My Tasks -->
            <div v-if="currentView === 'tasks' || currentView === 'my_tasks'">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        {{ currentView === 'my_tasks' ? 'งานของฉัน' : 'รายการงานทั้งหมด' }}
                        <span v-if="dashboardFilter" class="fs-6 badge bg-secondary ms-2">Filter: {{ dashboardFilter }}</span>
                        <button v-if="dashboardFilter" @click="dashboardFilter=null" class="btn btn-sm btn-outline-dark ms-1">Reset</button>
                    </h2>
                    
                    <div class="d-flex gap-2">
                        <select v-if="currentView === 'tasks' && currentUser.role === 'manager'" class="form-select w-auto" v-model="filterUser">
                            <option value="">กรองตามบุคคล (ทั้งหมด)</option>
                            <option v-for="u in users" :key="u.id" :value="u.id">{{ u.name }}</option>
                        </select>
                        <button v-if="currentUser.role === 'manager'" @click="openTaskModal()" class="btn btn-primary">
                            <i class="bi bi-plus-lg"></i> สร้างงานใหม่
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div v-for="task in filteredTasks" :key="task.id" class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <div>
                                        <span v-if="task.priority === 'urgent'" class="badge bg-danger me-1">งานด่วน</span>
                                        <span v-if="isOverdue(task)" class="badge bg-dark">ล่าช้า</span>
                                    </div>
                                    <span :class="getStatusBadge(task.status)">{{ getStatusText(task.status) }}</span>
                                </div>
                                <h5 class="card-title">{{ task.title }}</h5>
                                <p class="card-text text-muted text-truncate">{{ task.description }}</p>
                                
                                <div class="bg-light p-2 rounded mb-2" style="font-size: 0.9em;">
                                    <div><i class="bi bi-calendar-check me-1"></i> เริ่ม: {{ formatDateTime(task.start_date) }}</div>
                                    <div :class="isOverdue(task) ? 'text-danger fw-bold' : ''">
                                        <i class="bi bi-alarm me-1"></i> ส่ง: {{ formatDateTime(task.due_date) }}
                                    </div>
                                </div>
                                
                                <small class="text-muted d-block mb-2">
                                    <i class="bi bi-person-fill"></i> {{ getAssignedNames(task.assigned_to) }}
                                </small>

                                <div class="d-flex gap-2 mt-3">
                                    <button @click="openTaskDetail(task)" class="btn btn-outline-primary btn-sm flex-grow-1">รายละเอียด</button>
                                    
                                    <!-- Manager Actions -->
                                    <div v-if="currentUser.role === 'manager'">
                                        <button @click="openTaskModal(task)" class="btn btn-outline-warning btn-sm"><i class="bi bi-pencil"></i></button>
                                        <button @click="deleteTask(task.id)" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="filteredTasks.length === 0" class="col-12 text-center text-muted mt-5">
                        <i class="bi bi-inbox fs-1"></i>
                        <p>ไม่พบรายการงาน</p>
                    </div>
                </div>
            </div>

            <!-- Review View (Manager) -->
            <div v-if="currentView === 'review' && currentUser.role === 'manager'">
                <h2>Review งานที่เสร็จสิ้น</h2>
                <div class="card p-4">
                    <table class="table table-hover">
                        <thead><tr><th>ชื่องาน</th><th>ผู้รับผิดชอบ</th><th>เสร็จเมื่อ</th><th>จัดการ</th></tr></thead>
                        <tbody>
                            <tr v-for="task in pendingReviewTasks" :key="task.id">
                                <td>{{ task.title }}</td>
                                <td>{{ getAssignedNames(task.assigned_to) }}</td>
                                <td>{{ formatDateTime(task.updated_at) }}</td> <!-- Using updated_at as completion time approximate -->
                                <td>
                                    <button @click="openEvaluation(task)" class="btn btn-warning btn-sm">
                                        <i class="bi bi-star"></i> ให้คะแนน
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="pendingReviewTasks.length === 0"><td colspan="4" class="text-center">ไม่มีงานรอประเมิน</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- KPI View (Manager) -->
            <div v-if="currentView === 'kpi' && currentUser.role === 'manager'">
                <div class="d-flex justify-content-between mb-4">
                    <h2>KPI & Performance Reports</h2>
                    <div class="d-flex gap-2">
                        <input type="date" v-model="kpiStartDate" class="form-control">
                        <span class="align-self-center">-</span>
                        <input type="date" v-model="kpiEndDate" class="form-control">
                        <button @click="calculateKPI" class="btn btn-primary">Update</button>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Chart -->
                    <div class="col-md-12">
                        <div class="card p-4">
                            <h5>คะแนนเฉลี่ยรายบุคคล (KPI Score)</h5>
                            <div class="chart-container">
                                <canvas id="kpiChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Tasks -->
                    <div class="col-md-12">
                        <div class="card p-4">
                            <h5>อันดับงานคะแนนสูงสุด (ช่วงเวลาที่เลือก)</h5>
                            <table class="table">
                                <thead><tr><th>Rank</th><th>ชื่องาน</th><th>ผู้ทำ</th><th>คะแนนรวม</th></tr></thead>
                                <tbody>
                                    <tr v-for="(task, index) in topRatedTasks" :key="task.id">
                                        <td>#{{ index + 1 }}</td>
                                        <td>{{ task.title }}</td>
                                        <td>{{ getAssignedNames(task.assigned_to) }}</td>
                                        <td class="fw-bold text-success">{{ getTotalScore(task.evaluation) }}/15</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Management View (Manager) -->
            <div v-if="currentView === 'users' && currentUser.role === 'manager'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>จัดการทีม</h2>
                    <button @click="openUserModal()" class="btn btn-primary"><i class="bi bi-person-plus"></i> เพิ่มสมาชิก</button>
                </div>
                <div class="card p-4">
                    <table class="table">
                        <thead><tr><th>ชื่อ</th><th>แผนก</th><th>Username</th><th>Role</th><th>จัดการ</th></tr></thead>
                        <tbody>
                            <tr v-for="u in users" :key="u.id">
                                <td>{{ u.name }}</td>
                                <td>{{ u.department }}</td>
                                <td>{{ u.username }}</td>
                                <td>
                                    <span :class="u.role === 'manager' ? 'badge bg-danger' : 'badge bg-info text-dark'">{{ u.role }}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning me-1" @click="openUserModal(u)">แก้ไข</button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteUser(u.id)">ลบ</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SOP / WI / JD View -->
            <div v-if="currentView === 'sop'">
                <div class="d-flex justify-content-between mb-3">
                    <h2>คลังเอกสาร (SOP / WI / JD)</h2>
                    <button v-if="currentUser.role === 'manager'" @click="openDocModal" class="btn btn-primary">
                        <i class="bi bi-cloud-upload"></i> อัปโหลดเอกสาร
                    </button>
                </div>

                <div class="card p-3">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><a @click="sopTab='JD'" :class="['nav-link', sopTab==='JD'?'active':'']">Job Description (JD)</a></li>
                        <li class="nav-item"><a @click="sopTab='WI'" :class="['nav-link', sopTab==='WI'?'active':'']">Work Instruction (WI)</a></li>
                        <li class="nav-item"><a @click="sopTab='SOP'" :class="['nav-link', sopTab==='SOP'?'active':'']">SOP Standard</a></li>
                    </ul>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light"><tr><th>ชื่อเอกสาร</th><th>แผนก</th><th>ดาวน์โหลด</th><th v-if="currentUser.role==='manager'">จัดการ</th></tr></thead>
                            <tbody>
                                <tr v-for="doc in filteredDocs" :key="doc.id">
                                    <td><i class="bi bi-file-earmark-pdf text-danger me-2"></i> {{ doc.title }}</td>
                                    <td><span class="badge bg-secondary">{{ doc.department }}</span></td>
                                    <td><a :href="doc.url" target="_blank" class="btn btn-sm btn-outline-primary">เปิดอ่าน</a></td>
                                    <td v-if="currentUser.role==='manager'">
                                        <button @click="deleteDoc(doc.id)" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="filteredDocs.length === 0"><td colspan="4" class="text-center py-4">ไม่พบเอกสารในหมวดนี้สำหรับแผนกของคุณ</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ================== MODALS ================== -->

    <!-- Create/Edit Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ editingTask.id ? 'แก้ไขงาน' : 'สร้างงานใหม่' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">หัวข้องาน</label>
                            <input type="text" v-model="editingTask.title" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">รายละเอียด</label>
                            <textarea v-model="editingTask.description" class="form-control" rows="3"></textarea>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label text-primary">วันที่เริ่มงาน</label>
                            <input type="datetime-local" v-model="editingTask.start_date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-danger">กำหนดส่ง (Deadline)</label>
                            <input type="datetime-local" v-model="editingTask.due_date" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">ผู้รับผิดชอบ (เลือกได้หลายคน)</label>
                            <select multiple v-model="editingTask.assigned_to" class="form-select" size="4">
                                <option v-for="u in users" :key="u.id" :value="u.id" v-show="u.role !== 'manager'">{{ u.name }} ({{ u.department }})</option>
                            </select>
                            <small class="text-muted">กด Ctrl ค้างไว้เพื่อเลือกหลายคน</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ความเร่งด่วน</label>
                            <select v-model="editingTask.priority" class="form-select">
                                <option value="normal">ปกติ</option>
                                <option value="urgent">ด่วนมาก</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label"><i class="bi bi-paperclip"></i> แนบไฟล์</label>
                            <input type="file" @change="(e) => handleFileUpload(e, 'task')" class="form-control" :disabled="uploading">
                            <small class="text-muted" v-if="uploading">กำลังอัปโหลด...</small>
                            <div class="mt-2" v-if="editingTask.files && editingTask.files.length > 0">
                                <div v-for="(file, index) in editingTask.files" :key="index" class="file-attachment">
                                    <a :href="file.url" target="_blank">{{ file.name }}</a>
                                    <i class="bi bi-x-circle text-danger ms-1" style="cursor:pointer;" @click="removeFile(index)"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" @click="saveTask" :disabled="uploading">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail & Chat Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" v-if="activeTask">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">{{ activeTask.title }} <span v-if="activeTask.priority=='urgent'" class="badge bg-danger ms-2">Urgent</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-7 border-end">
                            <h6>รายละเอียด:</h6>
                            <p>{{ activeTask.description }}</p>
                            
                            <div class="row mb-3 bg-white p-3 border rounded">
                                <div class="col-6 mb-2"><strong>เริ่มงาน:</strong> <br>{{ formatDateTime(activeTask.start_date) }}</div>
                                <div class="col-6 mb-2 text-danger"><strong>กำหนดส่ง:</strong> <br>{{ formatDateTime(activeTask.due_date) }}</div>
                                <div class="col-12"><strong>ผู้รับงาน:</strong> {{ getAssignedNames(activeTask.assigned_to) }}</div>
                            </div>

                            <div v-if="activeTask.files && activeTask.files.length > 0" class="mb-3">
                                <h6><i class="bi bi-paperclip"></i> ไฟล์แนบ:</h6>
                                <div>
                                    <span v-for="(file, idx) in activeTask.files" :key="idx" class="file-attachment">
                                        <a :href="file.url" target="_blank" class="text-decoration-none">{{ file.name }}</a>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card bg-light p-3 mb-3">
                                <label class="form-label fw-bold">อัปเดตสถานะงาน:</label>
                                <select v-model="activeTask.status" @change="updateStatus(activeTask)" class="form-select w-50">
                                    <option value="pending">รอดำเนินการ</option>
                                    <option value="in_progress">กำลังดำเนินการ</option>
                                    <option value="completed">เสร็จสิ้น</option>
                                </select>
                            </div>

                            <div v-if="activeTask.evaluation" class="alert alert-success">
                                <h6><i class="bi bi-trophy-fill text-warning"></i> ผลการประเมิน</h6>
                                <div class="d-flex gap-4">
                                    <div>Speed: <i v-for="n in 5" :class="['bi', n<=activeTask.evaluation.speed ? 'bi-star-fill text-warning' : 'bi-star']"></i></div>
                                    <div>Quality: <i v-for="n in 5" :class="['bi', n<=activeTask.evaluation.quality ? 'bi-star-fill text-warning' : 'bi-star']"></i></div>
                                </div>
                                <div class="mt-2">Note: {{ activeTask.evaluation.note || '-' }}</div>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <h6><i class="bi bi-chat-dots"></i> พูดคุย / รายงานผล</h6>
                            <div class="chat-box mb-2" id="chatContainer">
                                <div v-for="msg in activeChat" :key="msg.id" :class="['chat-message', msg.user_id === currentUser.id ? 'chat-mine' : 'chat-other']">
                                    <small class="fw-bold d-block">{{ getUserName(msg.user_id) }}</small>
                                    <span>{{ msg.message }}</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="text" v-model="newMessage" @keyup.enter="sendMessage" class="form-control" placeholder="พิมพ์ข้อความ...">
                                <button @click="sendMessage" class="btn btn-primary"><i class="bi bi-send"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluation Modal (Stars) -->
    <div class="modal fade" id="evalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" v-if="evalData">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">ประเมินผลงาน (5 ดาว)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4 text-center">
                        <label class="fw-bold mb-2">ความรวดเร็ว (Speed)</label>
                        <div class="star-rating">
                            <i v-for="n in 5" :key="'s'+n" @click="evalData.speed = n" :class="['bi', n <= evalData.speed ? 'bi-star-fill active' : 'bi-star']"></i>
                        </div>
                    </div>
                    <div class="mb-4 text-center">
                        <label class="fw-bold mb-2">คุณภาพงาน (Quality)</label>
                        <div class="star-rating">
                            <i v-for="n in 5" :key="'q'+n" @click="evalData.quality = n" :class="['bi', n <= evalData.quality ? 'bi-star-fill active' : 'bi-star']"></i>
                        </div>
                    </div>
                    <div class="mb-4 text-center">
                        <label class="fw-bold mb-2">ความคิดสร้างสรรค์ (Creativity)</label>
                        <div class="star-rating">
                            <i v-for="n in 5" :key="'c'+n" @click="evalData.creativity = n" :class="['bi', n <= evalData.creativity ? 'bi-star-fill active' : 'bi-star']"></i>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>ความคิดเห็นเพิ่มเติม</label>
                        <textarea v-model="evalData.note" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="submitEvaluation" class="btn btn-primary w-100">บันทึกผลประเมิน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ editingUser.id ? 'แก้ไขผู้ใช้งาน' : 'เพิ่มผู้ใช้งานใหม่' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label>ชื่อ-นามสกุล</label><input v-model="editingUser.name" class="form-control"></div>
                    <div class="mb-2"><label>Username</label><input v-model="editingUser.username" class="form-control"></div>
                    <div class="mb-2"><label>Password</label><input v-model="editingUser.password" class="form-control" type="password"></div>
                    <div class="mb-2">
                        <label>แผนก</label>
                        <select v-model="editingUser.department" class="form-select">
                            <option value="General">General</option>
                            <option value="IT">IT</option>
                            <option value="Marketing">Marketing</option>
                            <option value="HR">HR</option>
                            <option value="Accounting">Accounting</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Role</label>
                        <select v-model="editingUser.role" class="form-select">
                            <option value="team">Team Member</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="saveUser" class="btn btn-primary">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Upload Modal (SOP) -->
    <div class="modal fade" id="docModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">อัปโหลดเอกสาร (SOP/WI/JD)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label>ชื่อเอกสาร</label><input v-model="newDoc.title" class="form-control"></div>
                    <div class="mb-3">
                        <label>ประเภท</label>
                        <select v-model="newDoc.category" class="form-select">
                            <option value="JD">Job Description</option>
                            <option value="WI">Work Instruction</option>
                            <option value="SOP">SOP</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>แผนกที่มีสิทธิ์เข้าถึง</label>
                        <select v-model="newDoc.department" class="form-select">
                            <option value="General">General</option>
                            <option value="IT">IT</option>
                            <option value="Marketing">Marketing</option>
                            <option value="HR">HR</option>
                            <option value="Accounting">Accounting</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>ไฟล์เอกสาร</label>
                        <input type="file" @change="(e) => handleFileUpload(e, 'doc')" class="form-control">
                        <small v-if="uploading" class="text-primary">Uploading...</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="saveDoc" class="btn btn-primary" :disabled="uploading || !newDoc.url">อัปโหลด</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
    const { createApp, ref, computed, reactive, onMounted, nextTick } = Vue;
    const { createClient } = supabase;

    /* --- Configuration --- */
    const supabaseUrl = 'https://obnndehnwjqyocxugbbq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ibm5kZWhud2pxeW9jeHVnYmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDQyNzIsImV4cCI6MjA4MTE4MDI3Mn0.lxix9WGTOFvvVwE8QjytNaFsH1mjqC9ncF1Z_ggmAyg';
    const _supabase = createClient(supabaseUrl, supabaseKey);

    createApp({
        setup() {
            // Global UI State
            const loading = ref(false);
            const isSidebarOpen = ref(true);
            const currentView = ref('dashboard');
            
            // User Data
            const currentUser = ref(null);
            const loginForm = reactive({ username: '', password: '' });
            const users = ref([]);
            const editingUser = ref({});
            
            // Task Data
            const tasks = ref([]);
            const filterUser = ref("");
            const dashboardFilter = ref(null); // 'urgent', 'overdue', 'pending', etc.
            
            // Active Items
            const activeTask = ref(null);
            const activeChat = ref([]);
            const newMessage = ref("");
            const editingTask = ref({ files: [] });
            const uploading = ref(false);
            
            // Evaluation
            const evalData = ref(null);

            // KPI
            const kpiStartDate = ref(new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10));
            const kpiEndDate = ref(new Date().toISOString().slice(0,10));
            let kpiChartInstance = null;

            // SOP
            const documents = ref([]);
            const sopTab = ref('JD');
            const newDoc = ref({ title: '', category: 'SOP', department: 'IT', url: '' });

            // Modals references
            let taskModal, detailModal, evalModal, userModal, docModal;

            // --- Authentication ---
            const login = async () => {
                loading.value = true;
                const { data } = await _supabase.from('users').select('*').eq('username', loginForm.username).eq('password', loginForm.password).single();
                if (data) {
                    currentUser.value = data;
                    await initData();
                } else {
                    alert('Username/Password ไม่ถูกต้อง');
                }
                loading.value = false;
            };
            const logout = () => { currentUser.value = null; tasks.value = []; };
            const toggleSidebar = () => isSidebarOpen.value = !isSidebarOpen.value;

            // --- Initial Data Load ---
            const initData = async () => {
                await fetchUsers();
                await fetchTasks();
                await fetchDocs();
            };
            
            const fetchUsers = async () => {
                const { data } = await _supabase.from('users').select('*');
                users.value = data || [];
            };

            const fetchTasks = async () => {
                const { data } = await _supabase.from('tasks').select('*').order('created_at', { ascending: false });
                tasks.value = data || [];
            };

            // --- Dashboard Logic ---
            const isOverdue = (task) => {
                return task.status !== 'completed' && new Date(task.due_date) < new Date();
            };

            const dashboardStats = computed(() => {
                const list = tasks.value;
                return {
                    total: list.length,
                    pending: list.filter(t => t.status === 'pending').length,
                    inProgress: list.filter(t => t.status === 'in_progress').length,
                    completed: list.filter(t => t.status === 'completed').length,
                    urgent: list.filter(t => t.priority === 'urgent').length,
                    overdue: list.filter(t => isOverdue(t)).length
                };
            });

            const setDashboardFilter = (type) => {
                dashboardFilter.value = type;
                currentView.value = 'tasks';
            };

            const urgentTasks = computed(() => {
                // Show Urgent or Overdue tasks that are not completed
                return tasks.value.filter(t => t.status !== 'completed' && (t.priority === 'urgent' || isOverdue(t)));
            });

            const filteredTasks = computed(() => {
                let res = tasks.value;
                
                // 1. Role Filter / My Tasks View
                if (currentView.value === 'my_tasks') {
                    res = res.filter(t => t.assigned_to && t.assigned_to.includes(currentUser.value.id));
                } else if (currentUser.value.role === 'team') {
                    res = res.filter(t => t.assigned_to && t.assigned_to.includes(currentUser.value.id));
                }
                
                // 2. Manager User Filter
                if (filterUser.value) {
                    res = res.filter(t => t.assigned_to && t.assigned_to.includes(filterUser.value));
                }

                // 3. Dashboard Click Filter
                if (dashboardFilter.value) {
                    if (dashboardFilter.value === 'overdue') res = res.filter(t => isOverdue(t));
                    else if (dashboardFilter.value === 'urgent') res = res.filter(t => t.priority === 'urgent');
                    else res = res.filter(t => t.status === dashboardFilter.value);
                }

                return res;
            });

            // --- Tasks Operations ---
            const openTaskModal = (task = null) => {
                taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                const formatForInput = (dateStr) => dateStr ? new Date(dateStr).toISOString().slice(0, 16) : '';
                if (task) {
                    editingTask.value = { ...task, start_date: formatForInput(task.start_date), due_date: formatForInput(task.due_date), files: task.files || [] };
                } else {
                    editingTask.value = { 
                        title: '', description: '', assigned_to: [], priority: 'normal', 
                        status: 'pending', created_by: currentUser.value.id, files: [], start_date: '', due_date: '' 
                    };
                }
                taskModal.show();
            };

            const saveTask = async () => {
                const payload = { ...editingTask.value };
                // Ensure assigned_to is array (Vue select multiple gives array, but check anyway)
                if(!Array.isArray(payload.assigned_to)) payload.assigned_to = [payload.assigned_to];

                if (payload.start_date) payload.start_date = new Date(payload.start_date).toISOString();
                if (payload.due_date) payload.due_date = new Date(payload.due_date).toISOString();

                if (payload.id) await _supabase.from('tasks').update(payload).eq('id', payload.id);
                else await _supabase.from('tasks').insert([payload]);

                await fetchTasks();
                taskModal.hide();
            };

            const deleteTask = async (id) => {
                if (confirm('ยืนยันการลบงานนี้?')) {
                    await _supabase.from('tasks').delete().eq('id', id);
                    await fetchTasks();
                }
            };

            const openTaskDetail = (task) => {
                activeTask.value = task;
                detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                detailModal.show();
                fetchChat(task.id);
            };

            // --- Chat ---
            const fetchChat = async (taskId) => {
                const { data } = await _supabase.from('comments').select('*').eq('task_id', taskId).order('created_at', { ascending: true });
                activeChat.value = data || [];
                nextTick(() => { const el = document.getElementById('chatContainer'); if(el) el.scrollTop = el.scrollHeight; });
            };
            const sendMessage = async () => {
                if (!newMessage.value.trim()) return;
                await _supabase.from('comments').insert([{ task_id: activeTask.value.id, user_id: currentUser.value.id, message: newMessage.value }]);
                newMessage.value = "";
                await fetchChat(activeTask.value.id);
            };

            // --- Evaluation & Review ---
            const pendingReviewTasks = computed(() => {
                return tasks.value.filter(t => t.status === 'completed' && !t.evaluation);
            });

            const pendingReviewCount = computed(() => pendingReviewTasks.value.length);

            const openEvaluation = (task) => {
                activeTask.value = task;
                evalData.value = { speed: 5, quality: 5, creativity: 5, note: '' };
                evalModal = new bootstrap.Modal(document.getElementById('evalModal'));
                evalModal.show();
            };

            const submitEvaluation = async () => {
                await _supabase.from('tasks').update({ evaluation: evalData.value }).eq('id', activeTask.value.id);
                evalModal.hide();
                await fetchTasks();
            };

            // --- User Management ---
            const openUserModal = (u = null) => {
                editingUser.value = u ? { ...u } : { name: '', username: '', password: '', role: 'team', department: 'General' };
                userModal = new bootstrap.Modal(document.getElementById('userModal'));
                userModal.show();
            };

            const saveUser = async () => {
                const u = editingUser.value;
                if (u.id) await _supabase.from('users').update(u).eq('id', u.id);
                else await _supabase.from('users').insert([u]);
                await fetchUsers();
                userModal.hide();
            };
            
            const deleteUser = async (id) => {
                if(confirm('ยืนยันลบผู้ใช้งานนี้?')) {
                    await _supabase.from('users').delete().eq('id', id);
                    await fetchUsers();
                }
            };

            // --- File Upload (Generic) ---
            const handleFileUpload = async (event, type) => {
                const file = event.target.files[0];
                if (!file) return;
                uploading.value = true;
                const fileName = `${Date.now()}_${file.name}`;
                
                const { error } = await _supabase.storage.from('task-files').upload(fileName, file);
                if (error) { alert('Upload failed: ' + error.message); uploading.value = false; return; }
                
                const { data } = _supabase.storage.from('task-files').getPublicUrl(fileName);
                const publicUrl = data.publicUrl;

                if (type === 'task') {
                    editingTask.value.files.push({ name: file.name, url: publicUrl });
                } else if (type === 'doc') {
                    newDoc.value.url = publicUrl;
                    newDoc.value.title = newDoc.value.title || file.name;
                }
                uploading.value = false;
            };

            const removeFile = (index) => editingTask.value.files.splice(index, 1);

            // --- SOP / Documents ---
            const fetchDocs = async () => {
                // Try to fetch documents. If table doesn't exist, this fails gracefully in demo
                const { data, error } = await _supabase.from('documents').select('*');
                if (!error) documents.value = data; 
            };

            const filteredDocs = computed(() => {
                return documents.value.filter(d => 
                    d.category === sopTab.value && 
                    (currentUser.value.role === 'manager' || d.department === currentUser.value.department)
                );
            });

            const openDocModal = () => {
                newDoc.value = { title: '', category: 'SOP', department: 'IT', url: '' };
                docModal = new bootstrap.Modal(document.getElementById('docModal'));
                docModal.show();
            };

            const saveDoc = async () => {
                // Create 'documents' table if not exists (SQL below)
                const { error } = await _supabase.from('documents').insert([newDoc.value]);
                if(error) alert('Error saving doc (Ensure table exists): ' + error.message);
                else {
                    await fetchDocs();
                    docModal.hide();
                }
            };

            const deleteDoc = async (id) => {
                if(confirm('ลบเอกสาร?')) {
                    await _supabase.from('documents').delete().eq('id', id);
                    await fetchDocs();
                }
            };

            // --- KPI Logic ---
            const getTotalScore = (ev) => ev ? (parseInt(ev.speed)+parseInt(ev.quality)+parseInt(ev.creativity)) : 0;

            const topRatedTasks = computed(() => {
                // Filter by date range and completed status
                const start = new Date(kpiStartDate.value);
                const end = new Date(kpiEndDate.value);
                end.setHours(23,59,59);

                let list = tasks.value.filter(t => 
                    t.status === 'completed' && t.evaluation &&
                    new Date(t.updated_at || t.created_at) >= start &&
                    new Date(t.updated_at || t.created_at) <= end
                );
                
                // Sort by total score DESC
                return list.sort((a,b) => getTotalScore(b.evaluation) - getTotalScore(a.evaluation)).slice(0, 10);
            });

            const calculateKPI = () => {
                // Group by User and Calculate Avg Score
                const start = new Date(kpiStartDate.value);
                const end = new Date(kpiEndDate.value);
                end.setHours(23,59,59);

                const stats = {};
                users.value.forEach(u => stats[u.name] = { total: 0, count: 0 });

                tasks.value.forEach(t => {
                    if (t.status === 'completed' && t.evaluation && new Date(t.updated_at) >= start && new Date(t.updated_at) <= end) {
                        t.assigned_to.forEach(uid => {
                            const uName = getUserName(uid);
                            if (stats[uName]) {
                                stats[uName].total += getTotalScore(t.evaluation);
                                stats[uName].count++;
                            }
                        });
                    }
                });

                const labels = [];
                const data = [];
                for (const name in stats) {
                    if (stats[name].count > 0) {
                        labels.push(name);
                        data.push((stats[name].total / stats[name].count).toFixed(1));
                    }
                }

                // Render Chart
                if (kpiChartInstance) kpiChartInstance.destroy();
                const ctx = document.getElementById('kpiChart');
                if (ctx) {
                    kpiChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'คะแนนเฉลี่ย (เต็ม 15)',
                                data: data,
                                backgroundColor: '#3498db',
                                borderRadius: 5
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, max: 15 } } }
                    });
                }
            };

            // Watch for view change to render chart
            Vue.watch(currentView, (newVal) => {
                if(newVal === 'kpi') setTimeout(calculateKPI, 500);
            });

            // --- Helpers ---
            const getAssignedNames = (ids) => {
                if (!ids || ids.length === 0) return "ไม่ระบุ";
                // Handle case where ids is not array
                const arr = Array.isArray(ids) ? ids : [ids];
                return arr.map(id => users.value.find(u => u.id === id)?.name || 'Unknown').join(', ');
            };
            const getUserName = (id) => users.value.find(u => u.id === id)?.name || 'User';
            const getStatusBadge = (status) => {
                const map = { pending: 'badge bg-warning text-dark', in_progress: 'badge bg-info', completed: 'badge bg-success' };
                return map[status] || 'badge bg-secondary';
            };
            const getStatusText = (status) => {
                const map = { pending: 'รอดำเนินการ', in_progress: 'กำลังทำ', completed: 'เสร็จสิ้น' };
                return map[status] || status;
            };
            const formatDateTime = (dateStr) => {
                if (!dateStr) return "-";
                const d = new Date(dateStr);
                return d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            };
            const updateStatus = async (task) => {
                await _supabase.from('tasks').update({ status: task.status, updated_at: new Date() }).eq('id', task.id);
            };

            return {
                currentUser, loginForm, loading, login, logout, 
                currentView, isSidebarOpen, toggleSidebar,
                dashboardStats, urgentTasks, tasks, filteredTasks, dashboardFilter, setDashboardFilter, isOverdue,
                users, filterUser,
                openTaskModal, editingTask, saveTask, deleteTask, uploading, handleFileUpload, removeFile,
                openTaskDetail, activeTask, updateStatus,
                activeChat, newMessage, sendMessage,
                // Review
                pendingReviewTasks, pendingReviewCount, openEvaluation, evalData, submitEvaluation,
                // Users
                openUserModal, editingUser, saveUser, deleteUser,
                // SOP
                documents, sopTab, filteredDocs, newDoc, openDocModal, saveDoc, deleteDoc,
                // KPI
                kpiStartDate, kpiEndDate, calculateKPI, topRatedTasks, getTotalScore,
                // Util
                getAssignedNames, getStatusBadge, getStatusText, formatDateTime, getUserName
            };
        }
    }).mount('#app');
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management System V.2.3</title>
    <!-- Dependencies -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #4a90e2; --bg-color: #f4f6f9; }
        body { background-color: var(--bg-color); font-family: 'Sarabun', sans-serif; overflow-x: hidden; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; transition: all 0.3s; width: 250px; position: fixed; z-index: 1000; }
        .sidebar.collapsed { width: 0; overflow: hidden; }
        .main-content { margin-left: 250px; padding: 20px; transition: all 0.3s; }
        .main-content.expanded { margin-left: 0; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; cursor: pointer; display: flex; align-items: center; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; border-right: 4px solid var(--primary-color); }
        .nav-link i { width: 25px; margin-right: 10px; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; margin-bottom: 20px; }
        .stat-card { transition: transform 0.2s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 2rem; opacity: 0.8; }
        .chat-box { height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 10px; padding: 15px; }
        .msg { padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; font-size: 0.9rem; }
        .msg-mine { background: #dcf8c6; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-other { background: #fff; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .task-status-pending { color: #f39c12; }
        .task-status-in_progress { color: #3498db; }
        .task-status-completed { color: #27ae60; }
        .priority-urgent { color: #e74c3c; font-weight: bold; }
        .overdue-row { background-color: #fff5f5; border-left: 4px solid #e74c3c; }
        /* Loader */
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="app">
    <!-- Loader -->
    <div v-if="loading" class="loader-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Login Screen -->
    <div v-if="!currentUser" class="d-flex justify-content-center align-items-center vh-100 bg-white">
        <div class="card p-4" style="width: 400px;">
            <div class="text-center mb-4">
                <i class="fas fa-tasks fa-3x text-primary mb-2"></i>
                <h4>Task Management</h4>
            </div>
            <form @submit.prevent="login">
                <div class="mb-3">
                    <label>Username</label>
                    <input v-model="loginForm.username" type="text" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Password</label>
                    <input v-model="loginForm.password" type="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div v-else>
        <!-- Sidebar -->
        <div class="sidebar" :class="{ collapsed: !isSidebarOpen }">
            <div class="p-3 border-bottom border-secondary">
                <h5 class="m-0"><i class="fas fa-cube me-2"></i>TMS V.2.3</h5>
                <small class="text-muted">{{ currentUser.name }} ({{ currentUser.role }})</small>
            </div>
            <nav class="mt-3">
                <div class="nav-link" :class="{ active: currentView === 'dashboard' }" @click="currentView = 'dashboard'">
                    <i class="fas fa-home"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Dashboard)
                </div>
                <div class="nav-link" :class="{ active: currentView === 'my_tasks' }" @click="currentView = 'my_tasks'">
                    <i class="fas fa-user-check"></i> ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </div>
                <div class="nav-link" :class="{ active: currentView === 'revisions' }" @click="currentView = 'revisions'">
                    <i class="fas fa-undo"></i> ‡∏á‡∏≤‡∏ô‡πÅ‡∏Å‡πâ (Revisions)
                </div>
                <div class="nav-link" :class="{ active: currentView === 'team_tasks' }" @click="currentView = 'team_tasks'" v-if="currentUser.role !== 'team'">
                    <i class="fas fa-users"></i> ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </div>
                <div class="nav-link" :class="{ active: currentView === 'evaluation' }" @click="currentView = 'evaluation'" v-if="currentUser.role !== 'team'">
                    <i class="fas fa-star-half-alt"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô
                </div>
                <div class="nav-link" :class="{ active: currentView === 'kpi' }" @click="currentView = 'kpi'" v-if="currentUser.role !== 'team'">
                    <i class="fas fa-chart-line"></i> KPI ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                </div>
                 <div class="nav-link" :class="{ active: currentView === 'my_kpi' }" @click="currentView = 'my_kpi'">
                    <i class="fas fa-chart-bar"></i> KPI ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </div>
                 <div class="nav-link" :class="{ active: currentView === 'one_on_one' }" @click="currentView = 'one_on_one'" v-if="currentUser.role !== 'team'">
                    <i class="fas fa-handshake"></i> 1 on 1 Report
                </div>
                <div class="nav-link mt-4 text-danger" @click="logout">
                    <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </div>
            </nav>
        </div>

        <!-- Content Area -->
        <div class="main-content" :class="{ expanded: !isSidebarOpen }">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button class="btn btn-light shadow-sm" @click="toggleSidebar"><i class="fas fa-bars"></i></button>
                <div class="d-flex gap-2">
                     <button class="btn btn-primary" @click="openTaskModal()" v-if="currentUser.role !== 'team'">
                        <i class="fas fa-plus me-1"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>

            <!-- DASHBOARD VIEW -->
            <div v-if="currentView === 'dashboard'">
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white h-100 p-3" @click="setDashboardDetailFilter(null)">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
                                    <h2>{{ dashboardStats.total }}</h2>
                                </div>
                                <i class="fas fa-folder stat-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-warning text-dark h-100 p-3" @click="setDashboardDetailFilter('pending')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h6>
                                    <h2>{{ dashboardStats.pending }}</h2>
                                </div>
                                <i class="fas fa-clock stat-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-info text-white h-100 p-3" @click="setDashboardDetailFilter('in_progress')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</h6>
                                    <h2>{{ dashboardStats.inProgress }}</h2>
                                </div>
                                <i class="fas fa-spinner stat-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-success text-white h-100 p-3" @click="setDashboardDetailFilter('completed')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</h6>
                                    <h2>{{ dashboardStats.completed }}</h2>
                                </div>
                                <i class="fas fa-check-circle stat-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-md-3">
                        <div class="card stat-card bg-danger text-white h-100 p-3" @click="setDashboardDetailFilter('overdue')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ (Overdue)</h6>
                                    <h2>{{ dashboardStats.overdue }}</h2>
                                </div>
                                <i class="fas fa-exclamation-triangle stat-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-dark text-white h-100 p-3" @click="setDashboardDetailFilter('urgent')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</h6>
                                    <h2>{{ dashboardStats.urgent }}</h2>
                                </div>
                                <i class="fas fa-fire stat-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-secondary text-white h-100 p-3" @click="setDashboardDetailFilter('revision')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>‡∏á‡∏≤‡∏ô‡πÅ‡∏Å‡πâ (Revisions)</h6>
                                    <h2>{{ dashboardStats.revision }}</h2>
                                </div>
                                <i class="fas fa-undo stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Detail Table -->
                <div class="card p-3">
                    <h5 class="mb-3 border-bottom pb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: {{ getDashboardFilterName(dashboardDetailFilter) }}</h5>
                    <div class="table-responsive">
                         <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
                                    <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                    <th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="task in dashboardDetailTasks" :key="task.id" :class="{'overdue-row': isOverdue(task)}">
                                    <td>
                                        <div class="fw-bold">{{ task.title }}</div>
                                        <span class="badge bg-danger" v-if="task.priority === 'urgent'">Urgent</span>
                                        <span class="badge bg-secondary" v-if="task.is_revision">Revision #{{ task.revision_history ? task.revision_history.length : 0 }}</span>
                                        <small v-if="isOverdue(task)" class="text-danger d-block"><i class="fas fa-clock"></i> ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</small>
                                    </td>
                                    <td>
                                        <div v-for="uid in task.assigned_to" :key="uid" class="badge bg-light text-dark me-1 border">
                                            {{ getUserName(uid) }}
                                        </div>
                                    </td>
                                    <td>{{ formatDateTime(task.due_date) }}</td>
                                    <td><span class="badge" :class="'bg-' + getStatusColor(task.status)">{{ getStatusText(task.status) }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info" @click="openTaskDetail(task)"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-warning ms-1" @click="openTaskModal(task)" v-if="currentUser.role !== 'team'"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="dashboardDetailTasks.length === 0"><td colspan="5" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TASK LIST VIEWS (My Tasks, Team Tasks, Revisions) -->
            <div v-if="['my_tasks', 'team_tasks', 'revisions'].includes(currentView)">
                <div class="card p-3">
                    <div class="d-flex justify-content-between mb-3">
                        <h5 v-if="currentView === 'my_tasks'">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h5>
                        <h5 v-else-if="currentView === 'revisions'">‡∏á‡∏≤‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Revisions)</h5>
                        <h5 v-else>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                        
                        <div class="d-flex gap-2">
                             <select v-model="filterStatus" class="form-select form-select-sm" style="width: 150px;">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                                <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                                <option value="urgent">‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</option>
                                <option value="overdue">‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</option>
                            </select>
                            <select v-if="currentView === 'team_tasks'" v-model="filterUser" class="form-select form-select-sm" style="width: 150px;">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>
                                <option v-for="u in users" :value="u.id">{{ u.name }}</option>
                            </select>
                        </div>
                    </div>
                     <div class="table-responsive">
                         <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
                                    <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                    <th>‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
                                    <th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="task in filteredTasks" :key="task.id" :class="{'overdue-row': isOverdue(task)}">
                                    <td>
                                        <div class="fw-bold">{{ task.title }}</div>
                                        <span class="badge bg-danger" v-if="task.priority === 'urgent'">Urgent</span>
                                        <span class="badge bg-secondary" v-if="task.is_revision">Rev #{{ task.revision_history?.length }}</span>
                                         <small v-if="isOverdue(task)" class="text-danger d-block"><i class="fas fa-clock"></i> ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</small>
                                    </td>
                                    <td>
                                         <div v-for="uid in task.assigned_to" :key="uid" class="badge bg-light text-dark me-1 border">
                                            {{ getUserName(uid) }}
                                        </div>
                                    </td>
                                    <td><small>{{ formatDateTime(task.start_date) }}</small></td>
                                    <td><small>{{ formatDateTime(task.due_date) }}</small></td>
                                    <td><span class="badge" :class="'bg-' + getStatusColor(task.status)">{{ getStatusText(task.status) }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info" @click="openTaskDetail(task)"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-warning ms-1" @click="openTaskModal(task)" v-if="currentUser.role !== 'team'"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger ms-1" @click="deleteTask(task.id)" v-if="currentUser.role === 'admin'"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="filteredTasks.length === 0"><td colspan="6" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- EVALUATION VIEW -->
            <div v-if="currentView === 'evaluation'">
                <div class="card p-3">
                    <div class="d-flex justify-content-between mb-3 align-items-center">
                         <h5>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</h5>
                         <div class="btn-group">
                             <button class="btn btn-outline-primary" :class="{active: reviewMode === 'pending'}" @click="reviewMode='pending'">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ({{ pendingReviewCount }})</button>
                             <button class="btn btn-outline-success" :class="{active: reviewMode === 'done'}" @click="reviewMode='done'">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
                         </div>
                    </div>
                     <table class="table align-middle">
                        <thead><tr><th>‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th><th>‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th></th></tr></thead>
                        <tbody>
                            <tr v-for="task in reviewListTasks" :key="task.id">
                                <td>{{ task.title }}</td>
                                <td><span v-for="uid in task.assigned_to" class="badge bg-light text-dark border me-1">{{ getUserName(uid) }}</span></td>
                                <td>{{ formatDateTime(task.completed_at) }}</td>
                                <td>
                                    <span v-if="task.evaluation" class="badge bg-success">{{ getTotalScore(task.evaluation) }}/20</span>
                                    <span v-else class="text-muted">-</span>
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" @click="openEvaluation(task)">
                                        <i class="fas fa-star"></i> {{ task.evaluation ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' }}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                     </table>
                </div>
            </div>

            <!-- KPI VIEWS (General, My KPI, 1 on 1) -->
            <div v-if="['kpi', 'my_kpi', 'one_on_one'].includes(currentView)">
                <div class="card p-3">
                    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 border-bottom pb-3">
                        <div>
                            <h4 v-if="currentView === 'kpi'">KPI ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</h4>
                            <h4 v-if="currentView === 'my_kpi'">KPI ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h4>
                            <h4 v-if="currentView === 'one_on_one'">1 on 1 Report</h4>
                            <p class="text-muted mb-0 small">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                        </div>
                        <div class="d-flex gap-2 align-items-end flex-wrap">
                            <div>
                                <label class="small fw-bold">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                                <input type="date" class="form-control form-control-sm" v-model="kpiStartDate" @change="calculateKPI">
                            </div>
                            <div>
                                <label class="small fw-bold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                                <input type="date" class="form-control form-control-sm" v-model="kpiEndDate" @change="calculateKPI">
                            </div>
                            <div v-if="currentView === 'one_on_one'">
                                <label class="small fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                                <select v-model="kpiSelectedUser" class="form-select form-select-sm" @change="calculateKPI" style="min-width:150px;">
                                    <option :value="null">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                                    <option v-for="u in users" :value="u.id">{{ u.name }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Area -->
                    <div style="height: 400px; position: relative;">
                         <canvas id="kpiChart"></canvas>
                         <div v-if="!kpiChartInstance && currentView === 'one_on_one' && !kpiSelectedUser" class="position-absolute top-50 start-50 translate-middle text-muted">
                             ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                         </div>
                    </div>

                    <!-- Top Tasks Table -->
                    <div class="mt-4">
                        <h5>üèÜ ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡πà‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Top Rated Tasks)</h5>
                        <table class="table table-sm table-bordered mt-2">
                            <thead class="table-light"><tr><th>‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th><th>‡∏à‡∏ö‡∏á‡∏≤‡∏ô</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead>
                            <tbody>
                                <tr v-for="task in topRatedTasks" :key="task.id">
                                    <td>{{ task.title }}</td>
                                    <td><span v-for="uid in task.assigned_to" class="badge bg-light text-dark border me-1">{{ getUserName(uid) }}</span></td>
                                    <td>{{ formatDateTime(task.completed_at) }}</td>
                                    <td class="fw-bold text-success">{{ getTotalScore(task.evaluation) }}/20</td>
                                </tr>
                                <tr v-if="topRatedTasks.length === 0"><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div> <!-- End Main Content -->
    </div>

    <!-- TASK MODAL (Create/Edit) -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ editingTask.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≤‡∏ô <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="editingTask.title" :class="{'is-invalid': attemptSave && !editingTask.title}">
                        </div>
                        <div class="col-12">
                            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î <span class="text-danger">*</span></label>
                            <textarea class="form-control" rows="3" v-model="editingTask.description" :class="{'is-invalid': attemptSave && !editingTask.description}"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label>‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ <span class="text-danger">*</span></label>
                            <select class="form-select" multiple v-model="editingTask.assigned_to" style="height: 100px;">
                                <option v-for="u in users" :value="u.id">{{ u.name }}</option>
                            </select>
                            <small class="text-muted">‡∏Å‡∏î Ctrl ‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</small>
                        </div>
                        <div class="col-md-6">
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                            <select class="form-select" v-model="editingTask.priority">
                                <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="urgent">‡∏î‡πà‡∏ß‡∏ô</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" v-model="editingTask.start_date" :class="{'is-invalid': attemptSave && !editingTask.start_date}">
                        </div>
                        <div class="col-md-6">
                            <label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á (Due Date) <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" v-model="editingTask.due_date" :class="{'is-invalid': attemptSave && !editingTask.due_date}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" @click="saveTask">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>{{ activeTask.title }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Left: Task Info -->
                        <div class="col-md-7 border-end">
                            <div class="mb-3">
                                <span class="badge bg-danger me-2" v-if="activeTask.priority === 'urgent'">Urgent</span>
                                <span class="badge" :class="'bg-' + getStatusColor(activeTask.status)">{{ getStatusText(activeTask.status) }}</span>
                                <span class="badge bg-secondary ms-2" v-if="activeTask.is_revision">Revision Round {{ activeTask.revision_history?.length || 0 }}</span>
                            </div>
                            <p class="text-muted" style="white-space: pre-wrap;">{{ activeTask.description }}</p>
                            
                            <hr>
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°:</small>
                                    <strong>{{ formatDateTime(activeTask.start_date) }}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:</small>
                                    <strong :class="{'text-danger': isOverdue(activeTask)}">{{ formatDateTime(activeTask.due_date) }}</strong>
                                </div>
                                <div class="col-12">
                                     <small class="text-muted d-block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</small>
                                     <div v-for="uid in activeTask.assigned_to" :key="uid" class="badge bg-light text-dark border me-1 p-2">
                                        {{ getUserName(uid) }}
                                     </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="card bg-light p-3">
                                <h6>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h6>
                                <div class="d-flex gap-2 align-items-center mb-3">
                                    <select class="form-select" v-model="tempStatus">
                                        <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                        <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                                        <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                                    </select>
                                    <button class="btn btn-primary" @click="updateStatusManual" :disabled="tempStatus === activeTask.status">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
                                </div>
                                <div v-if="currentUser.role !== 'team' && activeTask.status === 'completed'">
                                    <hr>
                                    <button class="btn btn-warning w-100" @click="requestRevision">
                                        <i class="fas fa-undo"></i> ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏á‡∏≤‡∏ô (Request Revision)
                                    </button>
                                </div>
                            </div>

                            <!-- Revision History -->
                            <div v-if="activeTask.revision_history && activeTask.revision_history.length > 0" class="mt-3">
                                <h6>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ</h6>
                                <ul class="list-group list-group-flush small">
                                    <li class="list-group-item" v-for="rev in activeTask.revision_history">
                                        <strong>‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà {{ rev.round }}:</strong> ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ formatDateTime(rev.requested_at) }} 
                                        <span v-if="rev.finished_at" class="text-success">(‡πÄ‡∏™‡∏£‡πá‡∏à {{ formatDateTime(rev.finished_at) }})</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Right: Chat -->
                        <div class="col-md-5">
                            <h6><i class="fas fa-comments"></i> ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå/‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h6>
                            <div class="chat-box mb-2" id="chatContainer">
                                <div v-for="chat in activeChat" :key="chat.id" class="msg" :class="chat.user_id === currentUser.id ? 'msg-mine' : 'msg-other'">
                                    <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span>{{ getUserName(chat.user_id) }}</span>
                                        <span>{{ formatDateTime(chat.created_at).slice(0,16) }}</span>
                                    </div>
                                    {{ chat.message }}
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control" v-model="newMessage" @keyup.enter="sendMessage" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
                                <button class="btn btn-primary" @click="sendMessage"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EVALUATION MODAL -->
    <div class="modal fade" id="evalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 text-center">
                        <h5>{{ activeTask.title }}</h5>
                        <p class="text-muted small">‡πÇ‡∏î‡∏¢: <span v-for="uid in activeTask.assigned_to">{{ getUserName(uid) }} </span></p>
                    </div>
                    <div class="row g-3">
                        <div class="col-12">
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß (1-5)</label>
                            <input type="range" class="form-range" min="1" max="5" v-model="evalData.speed">
                            <div class="text-center fw-bold text-primary">{{ evalData.speed }}</div>
                        </div>
                        <div class="col-12">
                            <label>‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô (1-5)</label>
                            <input type="range" class="form-range" min="1" max="5" v-model="evalData.quality">
                             <div class="text-center fw-bold text-primary">{{ evalData.quality }}</div>
                        </div>
                        <div class="col-12">
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå/‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (1-5)</label>
                            <input type="range" class="form-range" min="1" max="5" v-model="evalData.creativity">
                             <div class="text-center fw-bold text-primary">{{ evalData.creativity }}</div>
                        </div>
                         <div class="col-12">
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç/‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (Extra 0-5)</label>
                            <input type="range" class="form-range" min="0" max="5" v-model="evalData.urgency">
                             <div class="text-center fw-bold text-danger">{{ evalData.urgency }}</div>
                        </div>
                        <div class="col-12 border-top pt-2">
                            <div class="d-flex justify-content-between h5">
                                <span>‡∏£‡∏ß‡∏°:</span>
                                <span class="text-success">{{ parseInt(evalData.speed)+parseInt(evalData.quality)+parseInt(evalData.creativity)+parseInt(evalData.urgency) }} / 20</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    <button class="btn btn-success" @click="submitEvaluation">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
    // --- Config Supabase Here ---
    const SUPABASE_URL = ''; // ‡πÉ‡∏™‡πà URL Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SUPABASE_KEY = ''; // ‡πÉ‡∏™‡πà Key Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    createApp({
        setup() {
            // State
            const loading = ref(false);
            const currentUser = ref(null);
            const loginForm = ref({ username: '', password: '' });
            const isSidebarOpen = ref(true);
            const currentView = ref('dashboard');
            
            const users = ref([]);
            const tasks = ref([]);
            const filterUser = ref('');
            const filterStatus = ref('');
            const dashboardDetailFilter = ref(null);

            const editingTask = ref({});
            const attemptSave = ref(false);
            
            const activeTask = ref({});
            const tempStatus = ref('');
            const activeChat = ref([]);
            const newMessage = ref('');

            const reviewMode = ref('pending');
            const evalData = ref({});
            
            // KPI
            // Default: First day of current month to Today
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Format to YYYY-MM-DD for input type="date"
            const toIsoDate = (d) => {
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().slice(0,10);
            }

            const kpiStartDate = ref(toIsoDate(firstDay));
            const kpiEndDate = ref(toIsoDate(now));
            
            const kpiSelectedUser = ref(null); 
            let kpiChartInstance = null;

            // Modals references
            let taskModal, detailModal, evalModal;

            // --- Authentication ---
            onMounted(async () => {
                const session = localStorage.getItem('odf_session');
                if (session) {
                    currentUser.value = JSON.parse(session);
                    await initData();
                }
            });

            const login = async () => {
                loading.value = true;
                const { data } = await _supabase.from('users').select('*').eq('username', loginForm.value.username).eq('password', loginForm.value.password).single();
                if (data) {
                    currentUser.value = data;
                    localStorage.setItem('odf_session', JSON.stringify(data));
                    await initData();
                } else {
                    alert('Username/Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
                loading.value = false;
            };
            
            const logout = () => { 
                localStorage.removeItem('odf_session');
                location.reload(); 
            };
            const toggleSidebar = () => isSidebarOpen.value = !isSidebarOpen.value;

            // --- Initial Data Load ---
            const initData = async () => {
                loading.value = true;
                await fetchUsers();
                await fetchTasks();
                loading.value = false;
                
                // Calculate KPI initially
                if(['kpi', 'my_kpi', 'one_on_one'].includes(currentView.value)) {
                    calculateKPI();
                }
            };
            
            const fetchUsers = async () => {
                const { data } = await _supabase.from('users').select('*');
                users.value = data || [];
            };

            const fetchTasks = async () => {
                const { data } = await _supabase.from('tasks').select('*').order('created_at', { ascending: false });
                tasks.value = data || [];
            };
            
            // --- Helper Functions ---
            const getUserName = (id) => {
                const u = users.value.find(x => x.id == id);
                return u ? u.name : 'Unknown';
            };
            
            const formatDateTime = (isoStr) => {
                if(!isoStr) return '-';
                const d = new Date(isoStr);
                return d.toLocaleString('th-TH', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
            };

            const getStatusText = (s) => {
                const map = { pending:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', in_progress:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', completed:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' };
                return map[s] || s;
            };
            
            const getStatusColor = (s) => {
                const map = { pending:'warning', in_progress:'info', completed:'success' };
                return map[s] || 'secondary';
            };
            
            const checkAssignment = (assignedArr, userId) => {
                if (!assignedArr) return false;
                // Use loose comparison to allow string/int mismatch
                return assignedArr.some(id => id == userId);
            };

            // --- Dashboard Logic ---
            const isOverdue = (task) => {
                // Fixed Logic: Task is overdue if NOT completed AND Due Date < Now
                if (task.status === 'completed') return false;
                if (!task.due_date) return false;
                return new Date(task.due_date) < new Date();
            };

            const dashboardStats = computed(() => {
                let scopeTasks = tasks.value;
                if (currentUser.value && currentUser.value.role === 'team') {
                    scopeTasks = scopeTasks.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                }

                return {
                    total: scopeTasks.length,
                    pending: scopeTasks.filter(t => t.status === 'pending').length,
                    inProgress: scopeTasks.filter(t => t.status === 'in_progress').length,
                    completed: scopeTasks.filter(t => t.status === 'completed').length,
                    urgent: scopeTasks.filter(t => t.priority === 'urgent' && t.status !== 'completed').length,
                    revision: scopeTasks.filter(t => t.is_revision && t.status !== 'completed').length,
                    overdue: scopeTasks.filter(t => isOverdue(t)).length
                };
            });

            const setDashboardDetailFilter = (type) => {
                dashboardDetailFilter.value = type;
            };

            const getDashboardFilterName = (filter) => {
                if(!filter) return '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                const map = { urgent: '‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô', revision: '‡∏á‡∏≤‡∏ô‡πÅ‡∏Å‡πâ (Revision)', overdue: '‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤', pending: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', in_progress: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', completed: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' };
                return map[filter] || filter;
            };

            const dashboardDetailTasks = computed(() => {
                let res = tasks.value;
                if (currentUser.value && currentUser.value.role === 'team') {
                    res = res.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                }

                if (dashboardDetailFilter.value === 'overdue') res = res.filter(t => isOverdue(t));
                else if (dashboardDetailFilter.value === 'urgent') res = res.filter(t => t.priority === 'urgent' && t.status !== 'completed');
                else if (dashboardDetailFilter.value === 'revision') res = res.filter(t => t.is_revision && t.status !== 'completed');
                else if (dashboardDetailFilter.value) res = res.filter(t => t.status === dashboardDetailFilter.value);
                
                return res;
            });

            const filteredTasks = computed(() => {
                let res = tasks.value;
                
                if (currentView.value === 'my_tasks') {
                    res = res.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                } 
                
                // Add Revisions View Logic
                if (currentView.value === 'revisions') {
                    res = res.filter(t => t.is_revision === true);
                    if (currentUser.value.role === 'team') {
                        res = res.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                    }
                }
                
                if (currentView.value === 'team_tasks' && filterUser.value) {
                    res = res.filter(t => checkAssignment(t.assigned_to, filterUser.value));
                }

                if (filterStatus.value) {
                    if (filterStatus.value === 'urgent') res = res.filter(t => t.priority === 'urgent');
                    else if (filterStatus.value === 'overdue') res = res.filter(t => isOverdue(t));
                    else res = res.filter(t => t.status === filterStatus.value);
                }

                return res;
            });

            // --- Tasks Operations ---
            const openTaskModal = (task = null) => {
                attemptSave.value = false;
                taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                const formatForInput = (dateStr) => dateStr ? new Date(dateStr).toISOString().slice(0, 16) : '';
                if (task) {
                    editingTask.value = { ...task, start_date: formatForInput(task.start_date), due_date: formatForInput(task.due_date), files: task.files || [] };
                } else {
                    editingTask.value = { 
                        title: '', description: '', assigned_to: [], priority: 'normal', 
                        status: 'pending', created_by: currentUser.value.id, files: [], start_date: '', due_date: '' 
                    };
                }
                taskModal.show();
            };

            const saveTask = async () => {
                attemptSave.value = true;
                const t = editingTask.value;
                
                if (!t.title || !t.description || !t.start_date || !t.due_date || t.assigned_to.length === 0) {
                    return; 
                }

                const payload = { ...t };
                // REMOVED parseInt enforcement to allow generic IDs
                if(!Array.isArray(payload.assigned_to)) payload.assigned_to = [payload.assigned_to];

                if (payload.start_date) payload.start_date = new Date(payload.start_date).toISOString();
                if (payload.due_date) payload.due_date = new Date(payload.due_date).toISOString();
                
                // Set Original Dates for new tasks or tasks without them
                if (!payload.id || !payload.original_start_date) {
                    payload.original_start_date = payload.start_date;
                }
                if (!payload.id || !payload.original_due_date) {
                    payload.original_due_date = payload.due_date;
                }

                if (payload.status === 'completed' && !payload.completed_at) {
                    payload.completed_at = new Date().toISOString();
                }

                if (payload.id) await _supabase.from('tasks').update(payload).eq('id', payload.id);
                else await _supabase.from('tasks').insert([payload]);

                await fetchTasks();
                taskModal.hide();
                attemptSave.value = false;
            };

            const deleteTask = async (id) => {
                if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
                    await _supabase.from('tasks').delete().eq('id', id);
                    await fetchTasks();
                }
            };

            const openTaskDetail = (task) => {
                activeTask.value = JSON.parse(JSON.stringify(task)); 
                tempStatus.value = task.status; 
                detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                detailModal.show();
                fetchChat(task.id);
            };
            
            // Revised Update Status Logic
            const updateStatusManual = async () => {
                if(activeTask.value.status === tempStatus.value) return;
                
                if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô: ' + getStatusText(tempStatus.value) + '?')) {
                    const updates = { status: tempStatus.value, updated_at: new Date() };
                    
                    if (tempStatus.value === 'completed') {
                        updates.completed_at = new Date().toISOString();
                        
                        // 1. Set first_completed_at if not set
                        if (!activeTask.value.first_completed_at) {
                            updates.first_completed_at = new Date().toISOString();
                        }

                        // 2. If it is a revision, mark the last history item as finished
                        if (activeTask.value.is_revision && activeTask.value.revision_history?.length > 0) {
                            const history = [...activeTask.value.revision_history];
                            const lastIndex = history.length - 1;
                            history[lastIndex].finished_at = new Date().toISOString();
                            updates.revision_history = history;
                        }
                    } else {
                         // If moving back from completed, optionally clear completed_at (not strictly required but cleaner)
                         updates.completed_at = null;
                    }
                    
                    activeTask.value.status = tempStatus.value;
                    await _supabase.from('tasks').update(updates).eq('id', activeTask.value.id);
                    await fetchTasks(); // Refresh global list to update Dashboard counters
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
            };

            // NEW REVISION LOGIC (JSON Based)
            const requestRevision = async () => {
                // 1. Prompt for new deadline
                const newDateStr = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (YYYY-MM-DD HH:MM)", formatDateTime(new Date(new Date().getTime() + 24*60*60*1000)));
                if (!newDateStr) return; 

                const newDueDate = new Date(newDateStr);
                const validDate = !isNaN(newDueDate.getTime()) ? newDueDate : new Date(new Date().getTime() + 86400000);

                if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏á‡∏≤‡∏ô? \n‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà: " + formatDateTime(validDate.toISOString()))) return;
                
                // 2. Prepare History Object
                const currentHistory = activeTask.value.revision_history || [];
                const newRevisionEntry = {
                    round: currentHistory.length + 1,
                    requested_at: new Date().toISOString(),
                    finished_at: null,
                    due_date: validDate.toISOString(),
                    note: 'Requested by Manager'
                };
                const updatedHistory = [...currentHistory, newRevisionEntry];

                // 3. Update Task Data
                const updates = { 
                    status: 'pending', // Reset to pending
                    is_revision: true, // Mark as revision
                    updated_at: new Date(),
                    start_date: new Date().toISOString(), // Reset start time
                    due_date: validDate.toISOString(),
                    revision_history: updatedHistory
                };
                
                // Update Local State for immediate UI reflection
                activeTask.value.status = 'pending';
                activeTask.value.is_revision = true;
                activeTask.value.due_date = validDate.toISOString();
                activeTask.value.start_date = new Date().toISOString();
                activeTask.value.revision_history = updatedHistory;
                tempStatus.value = 'pending'; 
                
                await _supabase.from('tasks').update(updates).eq('id', activeTask.value.id);
                
                // No chat injection anymore
                await fetchChat(activeTask.value.id); 
                await fetchTasks(); 
            };

            // --- Chat ---
            const fetchChat = async (taskId) => {
                const { data } = await _supabase.from('comments').select('*').eq('task_id', taskId).order('created_at', { ascending: true });
                activeChat.value = data || [];
                nextTick(() => { 
                    const el = document.getElementById('chatContainer'); 
                    if(el) el.scrollTop = el.scrollHeight; 
                });
            };
            const sendMessage = async () => {
                if (!newMessage.value.trim()) return;
                await _supabase.from('comments').insert([{ task_id: activeTask.value.id, user_id: currentUser.value.id, message: newMessage.value }]);
                newMessage.value = "";
                await fetchChat(activeTask.value.id);
            };

            // --- Evaluation ---
            const reviewListTasks = computed(() => {
                if (reviewMode.value === 'pending') {
                    return tasks.value.filter(t => t.status === 'completed' && !t.evaluation);
                } else {
                    return tasks.value.filter(t => t.status === 'completed' && t.evaluation);
                }
            });

            const pendingReviewCount = computed(() => tasks.value.filter(t => t.status === 'completed' && !t.evaluation).length);

            const openEvaluation = (task) => {
                activeTask.value = task;
                evalData.value = task.evaluation || { speed: 5, quality: 5, creativity: 5, urgency: 5, note: '' };
                evalModal = new bootstrap.Modal(document.getElementById('evalModal'));
                evalModal.show();
            };

            const submitEvaluation = async () => {
                await _supabase.from('tasks').update({ evaluation: evalData.value }).eq('id', activeTask.value.id);
                evalModal.hide();
                await fetchTasks();
            };

            const getTotalScore = (ev) => ev ? (parseInt(ev.speed)+parseInt(ev.quality)+parseInt(ev.creativity)+parseInt(ev.urgency||0)) : 0;

            // --- KPI Logic ---
            const topRatedTasks = computed(() => {
                // Parse Input Dates (YYYY-MM-DD)
                const start = new Date(kpiStartDate.value); 
                const end = new Date(kpiEndDate.value + 'T23:59:59'); // Ensure end of day

                let list = tasks.value.filter(t => 
                    t.status === 'completed' && t.evaluation &&
                    new Date(t.updated_at || t.created_at) >= start &&
                    new Date(t.updated_at || t.created_at) <= end
                );

                if (currentView.value === 'my_kpi') {
                    list = list.filter(t => checkAssignment(t.assigned_to, currentUser.value.id));
                } else if (currentView.value === 'one_on_one' && kpiSelectedUser.value) {
                    list = list.filter(t => checkAssignment(t.assigned_to, kpiSelectedUser.value));
                }
                
                return list.sort((a,b) => getTotalScore(b.evaluation) - getTotalScore(a.evaluation));
            });

            const calculateKPI = () => {
                const start = new Date(kpiStartDate.value);
                const end = new Date(kpiEndDate.value + 'T23:59:59'); // Ensure end of day

                let relevantTasks = tasks.value.filter(t => 
                    t.status === 'completed' && t.evaluation && 
                    new Date(t.updated_at) >= start && new Date(t.updated_at) <= end
                );

                let targetUsers = users.value;
                if (currentView.value === 'my_kpi') {
                     targetUsers = [currentUser.value];
                } else if (currentView.value === 'one_on_one') {
                    if(!kpiSelectedUser.value) {
                        if (kpiChartInstance) kpiChartInstance.destroy();
                        return;
                    }
                    targetUsers = users.value.filter(u => u.id == kpiSelectedUser.value);
                }

                const stats = {};
                targetUsers.forEach(u => stats[u.name] = { total: 0, count: 0 });

                relevantTasks.forEach(t => {
                    t.assigned_to.forEach(uid => {
                        const uName = getUserName(uid);
                        if (stats[uName]) {
                            stats[uName].total += getTotalScore(t.evaluation);
                            stats[uName].count++;
                        }
                    });
                });

                const labels = [];
                const data = [];
                for (const name in stats) {
                    if (currentView.value === 'kpi') {
                        if (stats[name].count > 0) {
                            labels.push(name);
                            data.push((stats[name].total / stats[name].count).toFixed(1));
                        }
                    } else {
                        if (stats[name]) {
                            labels.push(name);
                            data.push(stats[name].count ? (stats[name].total / stats[name].count).toFixed(1) : 0);
                        }
                    }
                }

                if (kpiChartInstance) kpiChartInstance.destroy();
                const ctx = document.getElementById('kpiChart');
                if (ctx) {
                    kpiChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡πÄ‡∏ï‡πá‡∏° 20)',
                                data: data,
                                backgroundColor: '#3498db',
                                borderRadius: 5
                            }]
                        },
                        options: { 
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, max: 20 } } 
                        }
                    });
                }
            };

            Vue.watch(currentView, (newVal) => {
                if(['kpi', 'my_kpi', 'one_on_one'].includes(newVal)) setTimeout(calculateKPI, 500);
            });

            return {
                loading, currentUser, loginForm, isSidebarOpen, currentView,
                login, logout, toggleSidebar,
                users, tasks, filterUser, filterStatus, dashboardDetailFilter,
                dashboardStats, dashboardDetailTasks, setDashboardDetailFilter, getDashboardFilterName,
                filteredTasks,
                openTaskModal, saveTask, deleteTask, editingTask, attemptSave,
                activeTask, detailModal, openTaskDetail, updateStatusManual, tempStatus, requestRevision,
                activeChat, newMessage, sendMessage,
                reviewMode, reviewListTasks, pendingReviewCount, openEvaluation, submitEvaluation, evalData, getTotalScore,
                kpiStartDate, kpiEndDate, kpiSelectedUser, calculateKPI, topRatedTasks,
                getUserName, formatDateTime, getStatusText, getStatusColor, isOverdue
            };
        }
    }).mount('#app');
</script>
</body>
</html>
